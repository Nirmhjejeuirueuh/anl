---
import Icons from "@/helpers/Icons.astro";

interface Props {
  id?: string;
}

const { id = "video-modal" } = Astro.props;
---

<!-- Video Modal -->
<div
  id={id}
  class="hs-overlay group pointer-events-none fixed start-0 top-0 z-[9999] hidden size-full overflow-x-hidden overflow-y-auto"
  role="dialog"
  tabindex="-1">
  
  <!-- Fixed Backdrop -->
  <div class="fixed inset-0 bg-black opacity-0 transition-opacity duration-500 pointer-events-none group-[.hs-overlay-open]:opacity-60 -z-10 backdrop-blur-sm"></div>

  <div class="hs-overlay-animation-target mt-0 flex min-h-[calc(100%-3.5rem)] items-center opacity-0 transition-[margin,opacity] ease-out sm:mx-auto sm:w-full sm:max-w-4xl group-[.hs-overlay-open]:mt-7 group-[.hs-overlay-open]:opacity-100 group-[.hs-overlay-open]:duration-500 px-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full flex flex-col pointer-events-auto overflow-hidden border border-gray-100">
      <!-- Top Title Bar -->
      <div class="px-6 py-4 flex items-center justify-between border-b border-gray-100 bg-gray-50/50">
        <h3 class="video-title text-lg md:text-xl font-bold text-primary line-clamp-1"></h3>
        <button
          type="button"
          aria-label="Close"
          data-close-video-modal={id}
          class="flex h-9 w-9 items-center justify-center rounded-full bg-gray-200/50 text-gray-600 hover:bg-red-500 hover:text-white transition-all duration-300">
          <Icons icon="X" class="h-5 w-5" />
        </button>
      </div>

      <!-- Video Section -->
      <div class="relative aspect-video bg-black overflow-hidden">
        <div data-video-container={id} class="w-full h-full"></div>
      </div>

      <!-- Footer CTA Section -->
      <div class="p-6 flex justify-center bg-gray-50/30 border-t border-gray-100">
        <a 
          href="#" 
          target="_blank"
          rel="noopener noreferrer"
          class="learn-more-btn inline-flex items-center px-10 py-3.5 bg-primary text-white font-bold rounded-full hover:bg-primary/90 hover:scale-105 transition-all duration-300 shadow-md hover:shadow-lg"
          style="display: none;"
        >
          Learn More
          <svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  // @ts-nocheck
  import Plyr from 'plyr';
  import 'plyr/dist/plyr.css';
  
  // Only initialize once
  if (!window.videoModalInitialized) {
    window.videoModalInitialized = true;
    
    // Store players by modal ID
    if (!window.videoModalPlayers) {
      window.videoModalPlayers = new Map();
    }

    // Function to extract YouTube video ID from URL
    function getYouTubeVideoId(url) {
      if (!url) return null;
      const patterns = [
        /(?:youtube\.com\/watch\?v=)([^&]+)/,
        /(?:youtu\.be\/)([^?]+)/,
        /(?:youtube\.com\/embed\/)([^?]+)/,
        /(?:youtube\.com\/v\/)([^?]+)/
      ];
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match && match[1]) return match[1];
      }
      return null;
    }

  // Function to open video modal
  function openVideoModal(videoUrl, title, ctaUrl, modalId = 'video-modal') {
    if (!videoUrl) return;

    const videoId = getYouTubeVideoId(videoUrl);
    const isYouTube = videoId !== null;
    const isDirectVideo = videoUrl.match(/\.(mp4|webm|ogg|mov)(\?|$)/i);

    console.log('Opening video modal:', { videoUrl, isYouTube, isDirectVideo, modalId });

    if (!isYouTube && !isDirectVideo) {
      window.open(videoUrl, '_blank');
      return;
    }

    const modal = document.getElementById(modalId);
    const videoContainer = document.querySelector(`[data-video-container="${modalId}"]`);
    
    if (!modal || !videoContainer) return;

    videoContainer.innerHTML = '';

    // Update video info (title and button)
    const titleElement = modal.querySelector('.video-title');
    const learnMoreBtn = modal.querySelector('.learn-more-btn');
    
    if (titleElement) {
      titleElement.textContent = title || '';
    }
    
    if (learnMoreBtn) {
      if (ctaUrl) {
        learnMoreBtn.href = ctaUrl;
        learnMoreBtn.style.display = 'inline-flex';
      } else {
        learnMoreBtn.style.display = 'none';
      }
    }

    if (isYouTube) {
      videoContainer.setAttribute('data-plyr-provider', 'youtube');
      videoContainer.setAttribute('data-plyr-embed-id', videoId);
    } else {
      const videoElement = document.createElement('video');
      videoElement.setAttribute('playsinline', '');
      videoElement.setAttribute('controls', '');
      const sourceElement = document.createElement('source');
      sourceElement.setAttribute('src', videoUrl);
      sourceElement.setAttribute('type', 'video/mp4');
      videoElement.appendChild(sourceElement);
      videoContainer.appendChild(videoElement);
    }

    const player = new Plyr(videoContainer.querySelector('video') || videoContainer, {
      hideControls: false,
      controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'fullscreen'],
      youtube: { noCookie: true }
    });

    window.videoModalPlayers.set(modalId, player);

    // Show modal
    modal.classList.remove('hidden');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    // Trigger animation in next tick
    setTimeout(() => {
      modal.classList.add('hs-overlay-open');
      
      // Auto-play
      setTimeout(() => {
        player.play().catch(err => console.log('Autoplay prevented:', err));
      }, 600);
    }, 50);
  }

  // Function to close video modal
  function closeVideoModal(modalId = 'video-modal') {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // Get and destroy player
    const player = window.videoModalPlayers.get(modalId);
    if (player) {
      player.pause();
      player.destroy();
      window.videoModalPlayers.delete(modalId);
    }

    // Hide modal
    modal.classList.remove('hs-overlay-open');
    // Allow animation to finish before hiding
    setTimeout(() => {
      modal.classList.add('hidden');
      modal.style.display = '';
      document.body.style.overflow = '';
      
      // Clear video container and info
      const videoContainer = document.querySelector(`[data-video-container="${modalId}"]`);
      if (videoContainer) {
        videoContainer.innerHTML = '';
      }
      
      const learnMoreBtn = modal.querySelector('.learn-more-btn');
      if (learnMoreBtn) {
        learnMoreBtn.style.display = 'none';
      }
    }, 300);
  }

  // Setup video modal functionality
  function setupVideoModal(modalId = 'video-modal') {
    // Close modal button
    const closeButton = document.querySelector(`[data-close-video-modal="${modalId}"]`);
    if (closeButton) {
      closeButton.addEventListener('click', () => closeVideoModal(modalId));
    }

    // Close modal when clicking outside
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeVideoModal(modalId);
        }
      });
    }

    // Close modal on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const openModals = document.querySelectorAll('.hs-overlay-open');
        openModals.forEach(openModal => {
          const id = openModal.getAttribute('id');
          if (id && window.videoModalPlayers.has(id)) {
            closeVideoModal(id);
          }
        });
      }
    });
  }

  // Export functions globally
  if (typeof window !== 'undefined') {
    window.openVideoModal = openVideoModal;
    window.closeVideoModal = closeVideoModal;
    window.setupVideoModal = setupVideoModal;
    console.log('VideoModal functions exported to window');
  }

  // Auto-setup on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      console.log('VideoModal auto-setup running');
      // Setup all video modals on the page
      const allModals = document.querySelectorAll('[data-video-container]');
      console.log('Found video modal containers:', allModals.length);
      allModals.forEach(container => {
        const modalId = container.getAttribute('data-video-container');
        if (modalId) {
          console.log('Setting up video modal:', modalId);
          setupVideoModal(modalId);
        }
      });
    });
  } else {
    console.log('VideoModal auto-setup running (already loaded)');
    // Setup immediately if DOM is already loaded
    const allModals = document.querySelectorAll('[data-video-container]');
    console.log('Found video modal containers:', allModals.length);
    allModals.forEach(container => {
      const modalId = container.getAttribute('data-video-container');
      if (modalId) {
        console.log('Setting up video modal:', modalId);
        setupVideoModal(modalId);
      }
    });
  }
  
  } // End of videoModalInitialized check
</script>
