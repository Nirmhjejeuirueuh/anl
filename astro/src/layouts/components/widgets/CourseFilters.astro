---
import type { CollectionEntry } from "astro:content";
import { useTranslations } from "@/lib/utils/i18nUtils.ts";
import Icons from "@/helpers/Icons.astro";
import { pluralize } from "@/lib/utils/textConverter";

// Type for converted Strapi courses
interface ConvertedCourse {
  id: string;
  slug: string;
  collection: string;
  data: {
    title: string;
    date: Date;
    moduleCode?: string;
    courseFamily?: string;
    trainingDays?: number;
    schedule?: string;
    description?: string;
    learningObjectives?: string;
    targetAudience?: string;
    hyperlink?: string;
    status?: string;
    draft: boolean;
    featured?: boolean;
    dropdown?: string;
  };
  body: string;
  rendered: {
    html: string;
  };
}

interface Props {
  courses: ConvertedCourse[];
  class?: string;
}

const { courses, class: className } = Astro.props;
const t = await useTranslations(Astro.currentLocale as string);

// Extract unique categories and other filter options
const categories = [...new Set(courses.map(course => course.data.courseFamily).filter(Boolean))];
const durations = [...new Set(courses.map(course => course.data.trainingDays).filter((days): days is number => days != null).map(days => `${days} ${pluralize(days, 'day')}`))];

// Create course data for JavaScript
const coursesData = courses.map(course => ({
  id: course.id,
  title: course.data.title,
  description: course.data.description || course.data.learningObjectives || '',
  categories: course.data.courseFamily ? [course.data.courseFamily] : [],
  moduleCode: course.data.moduleCode,
  duration: course.data.trainingDays ? `${course.data.trainingDays} ${pluralize(course.data.trainingDays, 'day')}` : undefined,
  featured: Boolean(course.data.featured) || course.data.featured === 'true',
  tags: [],
  image: undefined,
  slug: course.slug,
}));
---

<div class:list={["course-filters bg-white border border-gray-200 rounded-lg p-6 mb-0 shadow-sm", className]}>
  <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-6">
    <h3 class="text-lg font-semibold text-gray-900">Filter & Search Courses</h3>
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <Icons icon="Filter" class="h-4 w-4" />
      <span id="course-count">{courses.length}</span>
      <span>courses found</span>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="mb-6">
    <div class="relative">
      <input
        type="text"
        id="course-search"
        placeholder="Search courses by title, description, or keywords..."
        class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      />
      <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
        <Icons icon="Search" class="h-5 w-5" />
      </div>
    </div>
  </div>

  <!-- Filters Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Category Filter -->
    <div>
      <label for="category-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Category
      </label>
      <select
        id="category-filter"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="">All Categories</option>
        {categories.map(category => (
          <option value={category}>{category}</option>
        ))}
      </select>
    </div>

    <!-- Duration Filter -->
    <div>
      <label for="duration-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Duration
      </label>
      <select
        id="duration-filter"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="">All Durations</option>
        {durations.map(duration => (
          <option value={duration}>{duration}</option>
        ))}
      </select>
    </div>

    <!-- Sort Options -->
    <div>
      <label for="sort-select" class="block text-sm font-medium text-gray-700 mb-2">
        Sort By
      </label>
      <select
        id="sort-select"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="title-asc">Title (A-Z)</option>
        <option value="title-desc">Title (Z-A)</option>
        <option value="duration-asc">Duration (Shortest)</option>
        <option value="duration-desc">Duration (Longest)</option>
        <option value="category-asc">Category (A-Z)</option>
      </select>
    </div>

    <!-- Popular Filter -->
    <div>
      <label class="flex items-center space-x-3 cursor-pointer group">
        <div class="relative">
          <input
            type="checkbox"
            id="popular-filter"
            class="sr-only peer"
          />
          <div class="w-12 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/25 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
        </div>
        <div class="flex flex-col">
          <span class="text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors">Popular Courses</span>
          <span class="text-xs text-gray-500">Show only featured courses</span>
        </div>
      </label>
    </div>
  </div>

  <!-- Active Filters & Clear Button -->
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div id="active-filters" class="flex flex-wrap gap-2">
      <!-- Active filter tags will be inserted here by JavaScript -->
    </div>
    <button
      id="clear-filters"
      class="px-4 py-2 text-sm text-[#db2f22] hover:text-white border border-[#db2f22] rounded-md hover:bg-[#db2f22] transition-colors hidden"
    >
      Clear All Filters
    </button>
  </div>
</div>

<script define:vars={{ coursesData }}>
  // Course filtering and sorting functionality
  class CourseFilters {
    constructor() {
      this.courses = coursesData;
      this.filteredCourses = [...this.courses];

      this.searchInput = document.getElementById('course-search');
      this.categoryFilter = document.getElementById('category-filter');
      this.durationFilter = document.getElementById('duration-filter');
      this.popularFilter = document.getElementById('popular-filter');
      this.sortSelect = document.getElementById('sort-select');
      this.clearFiltersBtn = document.getElementById('clear-filters');
      this.activeFiltersContainer = document.getElementById('active-filters');
      this.courseCount = document.getElementById('course-count');
      this.courseContainer = document.querySelector('.courses-container');

      this.loadFiltersFromStorage();
      this.init();
    }

    init() {
      // Store initial state - don't interfere with initial layout
      this.hasInteracted = false;

      // Check if all required elements exist
      if (!this.searchInput || !this.categoryFilter || !this.durationFilter ||
          !this.popularFilter || !this.sortSelect ||
          !this.clearFiltersBtn || !this.activeFiltersContainer || !this.courseCount) {
        console.error('CourseFilters: Some required elements are missing');
        return;
      }

      // Event listeners - only activate filtering when user interacts
      this.searchInput.addEventListener('input', () => {
        this.hasInteracted = true;
        this.filterCourses();
      });
      this.categoryFilter.addEventListener('change', () => {
        this.hasInteracted = true;
        this.filterCourses();
      });
      this.durationFilter.addEventListener('change', () => {
        this.hasInteracted = true;
        this.filterCourses();
      });
      this.popularFilter.addEventListener('change', () => {
        this.hasInteracted = true;
        this.filterCourses();
      });
      this.sortSelect.addEventListener('change', () => {
        this.hasInteracted = true;
        this.sortAndRenderCourses();
      });
      this.clearFiltersBtn.addEventListener('click', () => {
        this.hasInteracted = false;
        this.clearAllFilters();
      });

      // Event delegation for filter remove buttons
      this.activeFiltersContainer.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.filter-remove-btn');
        if (removeBtn) {
          e.preventDefault();
          e.stopPropagation();
          const index = parseInt(removeBtn.getAttribute('data-filter-index'), 10);
          if (!isNaN(index) && this.activeFilters && this.activeFilters[index]) {
            const filter = this.activeFilters[index];
            this.removeFilter(filter.type);
          }
        }
      });

      // Just update count initially - don't modify layout
      this.updateCourseCount();
    }

    filterCourses() {
      const searchTerm = this.searchInput.value.toLowerCase();
      const selectedCategory = this.categoryFilter.value;
      const selectedDuration = this.durationFilter.value;
      const showPopularOnly = this.popularFilter.checked;

      // Mark that filtering has occurred
      this.hasFiltered = true;

      this.filteredCourses = this.courses.filter(course => {
        // Search filter
        const matchesSearch = !searchTerm ||
          course.title.toLowerCase().includes(searchTerm) ||
          course.description.toLowerCase().includes(searchTerm) ||
          (course.moduleCode && course.moduleCode.toLowerCase().includes(searchTerm)) ||
          course.categories?.some(cat => cat.toLowerCase().includes(searchTerm));

        // Category filter
        const matchesCategory = !selectedCategory || course.categories?.includes(selectedCategory);

        // Duration filter
        const matchesDuration = !selectedDuration || course.duration === selectedDuration;

        // Popular filter
        const matchesPopular = !showPopularOnly || course.featured === true;

        return matchesSearch && matchesCategory && matchesDuration && matchesPopular;
      });

      this.updateActiveFilters();
      this.sortAndRenderCourses();
      this.saveFiltersToStorage();
    }

    sortCourses(courses) {
      const sortBy = this.sortSelect.value;

      return [...courses].sort((a, b) => {
        switch (sortBy) {
          case 'title-asc':
            return a.title.localeCompare(b.title);
          case 'title-desc':
            return b.title.localeCompare(a.title);
          case 'duration-asc':
            // Parse duration number from string like "5 days"
            const aDays = parseInt((a.duration || '').replace(/\D/g, '')) || 0;
            const bDays = parseInt((b.duration || '').replace(/\D/g, '')) || 0;
            return aDays - bDays;
          case 'duration-desc':
            const aDaysDesc = parseInt((a.duration || '').replace(/\D/g, '')) || 0;
            const bDaysDesc = parseInt((b.duration || '').replace(/\D/g, '')) || 0;
            return bDaysDesc - aDaysDesc;
          case 'category-asc':
            const aCat = a.categories?.[0] || '';
            const bCat = b.categories?.[0] || '';
            return aCat.localeCompare(bCat);
          default:
            return 0;
        }
      });
    }

    sortAndRenderCourses() {
      const sortedCourses = this.sortCourses(this.filteredCourses);
      this.renderCourses(sortedCourses);
      this.updateCourseCount();
      this.saveFiltersToStorage();
    }

    renderCourses(courses) {
      if (!this.courseContainer) return;

      // Only filter/render if user has interacted with filters
      if (!this.hasInteracted) return;

      // Clear existing courses
      this.courseContainer.innerHTML = '';

      if (courses.length === 0) {
        this.courseContainer.innerHTML = `
          <div class="col-span-full text-center py-12">
            <div class="text-gray-400 mb-4">
              <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-.98-5.5-2.5m-.5-4h.01"/>
              </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No courses found</h3>
            <p class="text-gray-500">Try adjusting your search or filter criteria.</p>
          </div>
        `;
        return;
      }

      courses.forEach((course, index) => {
        const courseElement = this.createCourseElement(course, index);
        this.courseContainer.appendChild(courseElement);
      });

      // Initialize lucide icons for newly rendered content
      this.initLucideIcons();
    }

    createCourseElement(course, index) {
      const div = document.createElement('div');
      div.className = 'bg-white h-full flex flex-col box-shadow-primary rounded-lg border border-gray-100 overflow-hidden';
      div.style.animationDelay = `${(index % 9) * 100}ms`;

      // Use the course slug directly
      const courseSlug = course.slug;

      div.innerHTML = `
        <div class="px-8 pt-10 pb-10 flex flex-col h-full">
          <div class="flex items-center gap-3 mb-4">
            <h3 class="text-h4 after:bg-primary relative inline-block pb-2 opacity-80 after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-10">${course.title}</h3>
          </div>

          ${course.categories?.length || course.moduleCode || course.duration ? `
            <div class="flex flex-wrap gap-3 mb-3 text-xs">
              ${course.categories?.[0] ? `<span class="inline-flex items-center gap-1 px-2 py-1 bg-[#00025d]/10 text-[#00025d] rounded-full"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>${course.categories[0]}</span>` : ''}
              ${course.moduleCode ? `<span class="inline-flex items-center gap-1 px-2 py-1 bg-[#FFEB3B]/10 text-[#14342B] rounded-full"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>${course.moduleCode}</span>` : ''}
              ${course.duration ? `<span class="inline-flex items-center gap-1 px-2 py-1 bg-[#43b14b]/10 text-[#43b14b] rounded-full"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>${course.duration}</span>` : ''}
            </div>
          ` : ''}

          <p class="text-text-default opacity-80 flex-1">${course.description && course.description.length > 200 ? course.description.substring(0, 200) + '...' : course.description}</p>

          <div class="mt-auto pt-4">
            <a href="/courses/${courseSlug}" class="text-primary hover:text-primary/80 font-medium text-sm capitalize">
              Read More â†’
            </a>
          </div>
        </div>
      `;

      return div;
    }



    updateActiveFilters() {
      const activeFilters = [];

      if (this.searchInput.value) {
        activeFilters.push({ type: 'search', value: this.searchInput.value, label: `Search: "${this.searchInput.value}"` });
      }

      if (this.categoryFilter.value) {
        activeFilters.push({ type: 'category', value: this.categoryFilter.value, label: `Category: ${this.categoryFilter.value}` });
      }

      if (this.durationFilter.value) {
        activeFilters.push({ type: 'duration', value: this.durationFilter.value, label: `Duration: ${this.durationFilter.value}` });
      }

      if (this.popularFilter.checked) {
        activeFilters.push({ type: 'popular', value: 'true', label: 'Popular Courses Only' });
      }

      // Store current active filters for removal
      this.activeFilters = activeFilters;

      this.activeFiltersContainer.innerHTML = activeFilters.map((filter, index) => `
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-[#43b14b]/10 text-[#43b14b] rounded-full text-sm filter-tag border border-[#43b14b]/20">
          ${filter.label}
          <button class="hover:bg-[#43b14b]/20 rounded-full p-0.5 filter-remove-btn transition-colors" type="button" data-filter-index="${index}">
            <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </span>
      `).join('');

      this.clearFiltersBtn.classList.toggle('hidden', activeFilters.length === 0);
    }

    removeFilter(type) {
      switch (type) {
        case 'search':
          this.searchInput.value = '';
          break;
        case 'category':
          this.categoryFilter.value = '';
          break;
        case 'duration':
          this.durationFilter.value = '';
          break;
        case 'popular':
          this.popularFilter.checked = false;
          break;
      }
      this.hasInteracted = true;
      this.filterCourses();
    }

    clearAllFilters() {
      this.searchInput.value = '';
      this.categoryFilter.value = '';
      this.durationFilter.value = '';
      this.popularFilter.checked = false;
      this.hasInteracted = false;
      localStorage.removeItem('courseFilters');
      this.filterCourses();
    }

    async initLucideIcons() {
      // Call the global initLucide function
      if (typeof window.initLucide === 'function') {
        await window.initLucide();
      }
    }

    loadFiltersFromStorage() {
      try {
        const savedFilters = localStorage.getItem('courseFilters');
        if (savedFilters) {
          const filters = JSON.parse(savedFilters);
          
          if (filters.search) this.searchInput.value = filters.search;
          if (filters.category) this.categoryFilter.value = filters.category;
          if (filters.duration) this.durationFilter.value = filters.duration;
          if (filters.popular !== undefined) this.popularFilter.checked = filters.popular;
          if (filters.sort) this.sortSelect.value = filters.sort;
          
          // Mark as interacted if any filters were loaded
          this.hasInteracted = !!(filters.search || filters.category || filters.duration || filters.popular);
        }
      } catch (error) {
        console.error('Failed to load filters from storage:', error);
      }
    }

    saveFiltersToStorage() {
      try {
        const filters = {
          search: this.searchInput.value,
          category: this.categoryFilter.value,
          duration: this.durationFilter.value,
          popular: this.popularFilter.checked,
          sort: this.sortSelect.value
        };
        localStorage.setItem('courseFilters', JSON.stringify(filters));
      } catch (error) {
        console.error('Failed to save filters to storage:', error);
      }
    }

    updateCourseCount() {
      this.courseCount.textContent = this.filteredCourses.length;
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    window.courseFilters = new CourseFilters();
  });

  // Also initialize immediately if DOM is already loaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.courseFilters = new CourseFilters();
    });
  } else {
    window.courseFilters = new CourseFilters();
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .course-card {
    animation: fadeInUp 0.6s ease-out forwards;
    opacity: 0;
    transform: translateY(20px);
    width: 100%;
    display: flex;
    flex-direction: column;
  }

  .course-card-list {
    animation: fadeInLeft 0.6s ease-out forwards;
    opacity: 0;
    transform: translateX(-20px);
  }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeInLeft {
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>