---
import { useTranslations } from "@/lib/utils/i18nUtils.ts";
import Icons from "@/helpers/Icons.astro";

// Type for converted Strapi trainings
interface ConvertedTraining {
  id: string;
  slug: string;
  collection: string;
  data: {
    title: string;
    image?: string;
    date: Date;
    trainingType: string;
    categories: string[];
    tags: string[];
    targetAudience?: string;
    duration?: string;
    trainingDays?: number;
    trainingTime?: string;
    trainingDate?: string;
    eligibilityCriteria?: string;
    accreditation?: string;
    ftsFunded?: boolean;
    fundingInfo?: string;
    partners?: string;
    framework?: string;
    steps?: string;
    trackRecord?: string;
    videoContent?: string;
    featured?: boolean;
    order?: number;
    seoTitle?: string;
    seoDescription?: string;
    keywords?: string;
    draft: boolean;
    excerpt?: string;
    description?: string;
  };
  body: string;
  rendered: {
    html: string;
  };
}

interface Props {
  trainings: ConvertedTraining[];
  class?: string;
}

const { trainings, class: className } = Astro.props;

// Extract unique categories and other filter options
const categories = [...new Set(trainings.flatMap(training => training.data.categories || []).filter(Boolean))];
const trainingTypes = [...new Set(trainings.map(training => training.data.trainingType).filter(Boolean))];
const durations = [...new Set(trainings.map(training => training.data.duration).filter(Boolean))];
const accreditations = [...new Set(trainings.map(training => training.data.accreditation).filter(Boolean))];

// Create training data for JavaScript
const trainingsData = trainings.map(training => ({
  id: training.id,
  title: training.data.title,
  description: training.data.description || training.data.excerpt || '',
  categories: training.data.categories || [],
  trainingType: training.data.trainingType,
  duration: training.data.duration,
  accreditation: training.data.accreditation,
  ftsFunded: training.data.ftsFunded,
  featured: training.data.featured,
  tags: training.data.tags || [],
  image: training.data.image,
  slug: training.slug,
}));
---

<div class:list={["training-filters bg-white border border-gray-200 rounded-lg p-6 mb-0 shadow-sm", className]}>
  <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between mb-6">
    <h3 class="text-lg font-semibold text-gray-900">Filter & Search Training Programs</h3>
    <div class="flex items-center gap-2 text-sm text-gray-600">
      <Icons icon="Filter" class="h-4 w-4" />
      <span id="training-count">{trainings.length}</span>
      <span>programs found</span>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="mb-6">
    <div class="relative">
      <input
        type="text"
        id="training-search"
        placeholder="Search training programs by title, description, or keywords..."
        class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      />
      <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400">
        <Icons icon="Search" class="h-5 w-5" />
      </div>
    </div>
  </div>

  <!-- Filters Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Category Filter -->
    <div>
      <label for="training-category-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Category
      </label>
      <select
        id="training-category-filter"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="">All Categories</option>
        {categories.map(category => (
          <option value={category}>{category}</option>
        ))}
      </select>
    </div>

    <!-- Training Type Filter -->
    <div>
      <label for="training-type-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Training Type
      </label>
      <select
        id="training-type-filter"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="">All Types</option>
        {trainingTypes.map(type => (
          <option value={type}>{type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>
        ))}
      </select>
    </div>

    <!-- Duration Filter -->
    <div>
      <label for="training-duration-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Duration
      </label>
      <select
        id="training-duration-filter"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="">All Durations</option>
        {durations.map(duration => (
          <option value={duration}>{duration}</option>
        ))}
      </select>
    </div>

    <!-- Accreditation Filter -->
    <div>
      <label for="training-accreditation-filter" class="block text-sm font-medium text-gray-700 mb-2">
        Accreditation
      </label>
      <select
        id="training-accreditation-filter"
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
      >
        <option value="">All Accreditations</option>
        {accreditations.map(accreditation => (
          <option value={accreditation}>{accreditation}</option>
        ))}
      </select>
    </div>
  </div>

  <!-- FTS Funded Toggle -->
  <div class="mb-6">
    <label class="flex items-center">
      <input
        type="checkbox"
        id="training-fts-filter"
        class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded"
      />
      <span class="ml-2 text-sm text-gray-700">FTS Funded Programs Only</span>
    </label>
  </div>

  <!-- Sort Options -->
  <div class="mb-6">
    <label for="training-sort-select" class="block text-sm font-medium text-gray-700 mb-2">
      Sort By
    </label>
    <select
      id="training-sort-select"
      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:border-primary outline-none transition-colors"
    >
      <option value="title-asc">Title (A-Z)</option>
      <option value="title-desc">Title (Z-A)</option>
      <option value="date-desc">Newest First</option>
      <option value="date-asc">Oldest First</option>
      <option value="category-asc">Category (A-Z)</option>
    </select>
  </div>

  <!-- Active Filters & Clear Button -->
  <div class="flex flex-wrap items-center justify-between gap-4">
    <div id="training-active-filters" class="flex flex-wrap gap-2">
      <!-- Active filter tags will be inserted here by JavaScript -->
    </div>
    <button
      id="training-clear-filters"
      class="px-4 py-2 text-sm text-[#db2f22] hover:text-white border border-[#db2f22] rounded-md hover:bg-[#db2f22] transition-colors hidden"
    >
      Clear All Filters
    </button>
  </div>
</div>

<script define:vars={{ trainingsData }} is:inline>
  // Training filtering and sorting functionality
  class TrainingFilters {
    constructor() {
      this.trainings = trainingsData;
      this.filteredTrainings = [...this.trainings];

      this.searchInput = document.getElementById('training-search');
      this.categoryFilter = document.getElementById('training-category-filter');
      this.typeFilter = document.getElementById('training-type-filter');
      this.durationFilter = document.getElementById('training-duration-filter');
      this.accreditationFilter = document.getElementById('training-accreditation-filter');
      this.ftsFilter = document.getElementById('training-fts-filter');
      this.sortSelect = document.getElementById('training-sort-select');
      this.clearFiltersBtn = document.getElementById('training-clear-filters');
      this.activeFiltersContainer = document.getElementById('training-active-filters');
      this.trainingCount = document.getElementById('training-count');
      this.trainingContainer = document.querySelector('.trainings-container');

      this.init();
    }

    init() {
      // Event listeners
      this.searchInput?.addEventListener('input', () => this.filterTrainings());
      this.categoryFilter?.addEventListener('change', () => this.filterTrainings());
      this.typeFilter?.addEventListener('change', () => this.filterTrainings());
      this.durationFilter?.addEventListener('change', () => this.filterTrainings());
      this.accreditationFilter?.addEventListener('change', () => this.filterTrainings());
      this.ftsFilter?.addEventListener('change', () => this.filterTrainings());
      this.sortSelect?.addEventListener('change', () => this.sortTrainings());
      this.clearFiltersBtn?.addEventListener('click', () => this.clearAllFilters());

      // Initial render
      this.renderTrainings();
    }

    filterTrainings() {
      const searchTerm = this.searchInput?.value.toLowerCase() || '';
      const categoryFilter = this.categoryFilter?.value || '';
      const typeFilter = this.typeFilter?.value || '';
      const durationFilter = this.durationFilter?.value || '';
      const accreditationFilter = this.accreditationFilter?.value || '';
      const ftsFilter = this.ftsFilter?.checked || false;

      this.filteredTrainings = this.trainings.filter(training => {
        const matchesSearch = !searchTerm ||
          training.title.toLowerCase().includes(searchTerm) ||
          training.description.toLowerCase().includes(searchTerm) ||
          training.tags.some(tag => tag.toLowerCase().includes(searchTerm));

        const matchesCategory = !categoryFilter || training.categories.includes(categoryFilter);
        const matchesType = !typeFilter || training.trainingType === typeFilter;
        const matchesDuration = !durationFilter || training.duration === durationFilter;
        const matchesAccreditation = !accreditationFilter || training.accreditation === accreditationFilter;
        const matchesFTS = !ftsFilter || training.ftsFunded === true;

        return matchesSearch && matchesCategory && matchesType && matchesDuration && matchesAccreditation && matchesFTS;
      });

      this.updateActiveFilters();
      this.renderTrainings();
    }

    sortTrainings() {
      const sortBy = this.sortSelect?.value || 'title-asc';

      this.filteredTrainings.sort((a, b) => {
        switch (sortBy) {
          case 'title-asc':
            return a.title.localeCompare(b.title);
          case 'title-desc':
            return b.title.localeCompare(a.title);
          case 'date-desc':
            return new Date(b.date || 0).getTime() - new Date(a.date || 0).getTime();
          case 'date-asc':
            return new Date(a.date || 0).getTime() - new Date(b.date || 0).getTime();
          case 'category-asc':
            return (a.categories[0] || '').localeCompare(b.categories[0] || '');
          default:
            return 0;
        }
      });

      this.renderTrainings();
    }

    updateActiveFilters() {
      const activeFilters = [];

      if (this.searchInput?.value) {
        activeFilters.push({ type: 'search', value: this.searchInput.value, label: `Search: "${this.searchInput.value}"` });
      }
      if (this.categoryFilter?.value) {
        activeFilters.push({ type: 'category', value: this.categoryFilter.value, label: `Category: ${this.categoryFilter.value}` });
      }
      if (this.typeFilter?.value) {
        activeFilters.push({ type: 'type', value: this.typeFilter.value, label: `Type: ${this.typeFilter.value.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}` });
      }
      if (this.durationFilter?.value) {
        activeFilters.push({ type: 'duration', value: this.durationFilter.value, label: `Duration: ${this.durationFilter.value}` });
      }
      if (this.accreditationFilter?.value) {
        activeFilters.push({ type: 'accreditation', value: this.accreditationFilter.value, label: `Accreditation: ${this.accreditationFilter.value}` });
      }
      if (this.ftsFilter?.checked) {
        activeFilters.push({ type: 'fts', value: 'true', label: 'FTS Funded' });
      }

      this.activeFiltersContainer.innerHTML = activeFilters.map(filter => `
        <span class="inline-flex items-center gap-1 px-2 py-1 bg-primary/10 text-primary text-xs rounded-full">
          ${filter.label}
          <button onclick="window.trainingFilters.removeFilter('${filter.type}', '${filter.value}')" class="ml-1 hover:text-red-600">
            Ã—
          </button>
        </span>
      `).join('');

      this.clearFiltersBtn?.classList.toggle('hidden', activeFilters.length === 0);
    }

    removeFilter(type, value) {
      switch (type) {
        case 'search':
          this.searchInput.value = '';
          break;
        case 'category':
          this.categoryFilter.value = '';
          break;
        case 'type':
          this.typeFilter.value = '';
          break;
        case 'duration':
          this.durationFilter.value = '';
          break;
        case 'accreditation':
          this.accreditationFilter.value = '';
          break;
        case 'fts':
          this.ftsFilter.checked = false;
          break;
      }
      this.filterTrainings();
    }

    clearAllFilters() {
      this.searchInput.value = '';
      this.categoryFilter.value = '';
      this.typeFilter.value = '';
      this.durationFilter.value = '';
      this.accreditationFilter.value = '';
      this.ftsFilter.checked = false;
      this.filterTrainings();
    }

    renderTrainings() {
      if (!this.trainingContainer) return;

      // Update count
      if (this.trainingCount) {
        this.trainingCount.textContent = this.filteredTrainings.length;
      }

      // For now, just log the filtered trainings - the actual rendering would need to be integrated with the grid
      console.log('Filtered trainings:', this.filteredTrainings.length, this.filteredTrainings);
    }
  }

  // Initialize filters when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    window.trainingFilters = new TrainingFilters();
  });
</script>