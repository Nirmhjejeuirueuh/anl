---
import Marquee from "@/components/widgets/Marquee.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import type { Section } from "@/types";
import { markdownify } from "@/lib/utils/textConverter";
import type { TypeOf } from "astro:schema";
import type { marqueeConfig } from "@/content.config";

// Type for this section data
export type sectionType = Section & {
  marquee?: TypeOf<typeof marqueeConfig>;
  list?: string[];
};
type Props = {
  content?: sectionType;
  images?: any[];
};

// Fetching the default content for the this section
let defaultContent = (
  await getEntryCTM("sections", "about-banner", Astro.currentLocale)
)?.data as sectionType;

// Enables content customization (e.g., title, description) with a fallback to 'defaultContent' if not provided.
// The 'content' prop should match the structure of 'defaultContent'.
// Allows using this section with different content across multiple pages.
// If 'content' is missing, 'defaultContent' will be used.
let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as sectionType;

// Extracting required values from 'content' object
let {
  enable = true,
  title,
  description,
  list,
  limit,
  marquee,
} = actualContent as sectionType;

// Use images from props if provided, otherwise use list
let images = Astro.props.images;
let imageData: Array<{url: string, width: number, height: number, caption?: string}> = [];

if (images && images.length > 0) {
  imageData = images.map((img: any) => ({
    url: img.url.startsWith('http') ? img.url : `${import.meta.env.STRAPI_URL || 'http://localhost:1337'}${img.url}`,
    width: img.width,
    height: img.height,
    caption: img.caption
  }));
  list = imageData.map(img => img.url);
}

// If no list is provided, use default about images
if (!list || list.length === 0) {
  list = [
    "/images/about/Agile for Successful Project Implementation_20210505-06.jpg",
    "/images/about/Anti-Money Laundering & its Ecosystem_20190830-Team Photo_Group 5.jpg",
    "/images/about/Applying User Entity Behavioural Analytics_20210223_Photo 1.jpg",
    "/images/about/Asean Cybersecurity Skilling Programme-20230523_Agenda.jpg",
    "/images/about/Asean Cybersecurity Skilling Programme-20230523_Group Photo.jpeg",
    "/images/about/Cloud Computing Essentials (for Financial Sector)_20191029_Photo 2.jpg",
    "/images/about/Cloud In Finance_20210813_Group 1 Assignment.jpg",
    "/images/about/Cloud In Finance_20210813_Group 3 Assignment.jpg",
    "/images/about/Moderated the Fireside Chat with Piyush Gupta_20230323.jpeg",
    "/images/about/TR-Confirmation Auditor & Banks Client Networking Event_20251114-Photo 2.jpeg",
    "/images/about/TR-Confirmation Auditor & Banks Client Networking Event_20251114-Photo 3.jpeg"
  ];
}

// Limit the number of items to be displayed
list = limit && list ? list.slice(0, limit as number) : list;

// Dynamically add text-highlight svg image to the title
const rawSvgs = import.meta.glob("/src/assets/images/**/*.svg", {
  query: "raw",
  import: "default",
});
const svgImage = await rawSvgs["/src/assets/images/text-highlight.svg"]();
const markdownTitle = await markdownify(title || "");
const formattedTitle = markdownTitle.replace(
  "<strong>",
  `<strong class='match-brand-color'>${svgImage}`,
);
---

{
  enable && (
    <section class="relative py-16 md:py-20 lg:py-24 overflow-hidden">
      <!-- Modern Background Pattern -->
      <div class="absolute inset-0 bg-gradient-to-br from-primary/5 via-secondary/5 to-white">
        <!-- Wave Pattern -->
        <div class="absolute inset-0 opacity-40">
          <svg class="absolute inset-0 w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none">
            <path d="M0,0 C150,40 350,40 600,20 C850,0 1050,0 1200,20 L1200,120 L0,120 Z" fill="currentColor" class="text-primary/10"/>
          </svg>
          <svg class="absolute inset-0 w-full h-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none" style="transform: translateY(20px);">
            <path d="M0,20 C200,60 400,60 600,40 C800,20 1000,20 1200,40 L1200,120 L0,120 Z" fill="currentColor" class="text-secondary/10"/>
          </svg>
        </div>
        
        <!-- Soft Gradient Orbs -->
        <div class="absolute -top-10 -right-10 w-64 h-64 bg-gradient-to-br from-primary/10 to-transparent rounded-full blur-3xl"></div>
        <div class="absolute -bottom-10 -left-10 w-64 h-64 bg-gradient-to-tr from-secondary/10 to-transparent rounded-full blur-3xl"></div>
      </div>

      <div class="relative container flex flex-col items-center justify-center gap-y-5 text-center z-10">
        {title && (
          <h2
            class="text-h3 has-text-highlight text-inherit"
            set:html={formattedTitle}
          />
        )}
        {description && (
          <div
            data-aos="fade-up-sm"
            data-aos-delay="200"
            set:html={markdownify(description)}
            class="prose prose-lg max-w-2xl opacity-90 xl:max-w-3xl"
          />
        )}
      </div>

      {list && marquee && (
        <div
          class="relative mt-16 flex justify-center overflow-x-hidden md:mt-32"
          data-aos="fade-up-sm"
          data-aos-delay="300">
          <Marquee marqueeElements={list.length} {...marquee}>
            {(imageData.length > 0 ? imageData : list.map(url => ({ url, width: 800, height: 600, caption: undefined }))).map((item, index) => (
              <div
                class:list={[
                  "px-4 h-96 md:h-112 flex-shrink-0",
                ]}>
                <div class="relative group cursor-pointer h-full flex items-center justify-center overflow-hidden" onclick={`openImageModal('${item.url}', '${item.caption || ''}')`}>
                  <OptimizedImage
                    class:list={[
                      "max-h-full w-auto transition-transform group-hover:scale-105",
                    ]}
                    src={item.url}
                    width={item.width || 800}
                    height={item.height || 600}
                    alt="Image"
                  />
                  {item.caption && (
                    <div class="absolute bottom-0 left-0 right-0 text-white text-sm p-2" style="background-color: rgba(0, 0, 0, 0.5);">
                      {item.caption}
                    </div>
                  )}
                </div>
              </div>
            ))}
            {(imageData.length > 0 ? imageData : list.map(url => ({ url, width: 800, height: 600, caption: undefined }))).map((item, index) => (
              <div
                class:list={[
                  "px-4 h-96 md:h-112 flex-shrink-0",
                ]}
                aria-hidden="true">
                <div class="relative group cursor-pointer h-full flex items-center justify-center overflow-hidden" onclick={`openImageModal('${item.url}', '${item.caption || ''}')`}>
                  <OptimizedImage
                    class:list={[
                      "max-h-full w-auto transition-transform group-hover:scale-105",
                    ]}
                    src={item.url}
                    width={item.width || 800}
                    height={item.height || 600}
                    alt="Image"
                  />
                  {item.caption && (
                    <div class="absolute bottom-0 left-0 right-0 text-white text-sm p-2" style="background-color: rgba(0, 0, 0, 0.5);">
                      {item.caption}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </Marquee>
        </div>
      )}

      <!-- Image Modal -->
      <div id="imageModal" class="fixed inset-0 z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
        <div class="relative w-full h-full flex flex-col items-center justify-center p-4">
          <div class="relative">
            <img id="modalImage" src="" alt="" class="max-w-full max-h-[80vh] object-contain" />
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white text-4xl hover:text-gray-300 z-10 w-12 h-12 flex items-center justify-center bg-black/80 rounded-full">&times;</button>
          </div>
          <div id="modalCaption" class="text-white text-center mt-4 max-w-4xl px-4"></div>
        </div>
      </div>

      <script is:inline>
        window.openImageModal = function(imageUrl, caption) {
          const modal = document.getElementById('imageModal');
          const modalImage = document.getElementById('modalImage');
          const modalCaption = document.getElementById('modalCaption');

          modalImage.src = imageUrl;
          modalCaption.textContent = caption;
          modal.classList.remove('hidden');
        }

        window.closeImageModal = function() {
          const modal = document.getElementById('imageModal');
          modal.classList.add('hidden');
        }

        // Close modal when clicking outside the image
        document.getElementById('imageModal')?.addEventListener('click', function(e) {
          if (e.target === this) {
            window.closeImageModal();
          }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            window.closeImageModal();
          }
        });
      </script>
    </section>
  )
}
