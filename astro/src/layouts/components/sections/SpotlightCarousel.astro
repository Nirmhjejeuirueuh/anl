---
// Spotlight Carousel Section with Swiper + Plyr
import { markdownify } from "@/lib/utils/textConverter";
import { getSpotlights } from "@/lib/utils/strapiApi";

interface SpotlightItem {
  videoUrl?: string;
  isYouTube?: boolean;
  videoId?: string;
  originalIndex?: number;
}

// Helper function to extract YouTube video ID
function getYouTubeVideoId(url: string): string | null {
  if (!url) return null;
  const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
  const match = url.match(youtubeRegex);
  return match && match[1] ? match[1] : null;
}

// Fetch spotlights from Strapi
const strapiSpotlights = await getSpotlights();
console.log('SpotlightCarousel: Fetched', strapiSpotlights.length, 'spotlights from Strapi');

// Convert Strapi data to component format
const spotlightItems: SpotlightItem[] = strapiSpotlights
  .map(spotlight => {
    let videoUrl: string | undefined;
    let isYouTube = false;
    let videoId: string | undefined;

    // Check for external video URL first (YouTube)
    if (spotlight.videoUrl) {
      videoId = getYouTubeVideoId(spotlight.videoUrl);
      if (videoId) {
        isYouTube = true;
        videoUrl = spotlight.videoUrl;
      } else {
        videoUrl = spotlight.videoUrl;
      }
    }
    // Fallback to uploaded video file
    else if (spotlight.video?.url) {
      videoUrl = spotlight.video.url.startsWith('http')
        ? spotlight.video.url
        : `${import.meta.env.STRAPI_URL || 'http://localhost:1337'}${spotlight.video.url}`;
      isYouTube = false;
    }

    console.log('Video:', { videoUrl, isYouTube, videoId });

    return {
      videoUrl,
      isYouTube,
      videoId
    };
  })
  .filter(item => item.videoUrl);

console.log('SpotlightCarousel: Filtered to', spotlightItems.length, 'items with videos');

// Section header content
const sectionTitle = "Don't Miss Out on **Upcoming Events**";
const sectionSubtitle = "In The Spotlight";

// Only render the section if there are spotlights to show
const hasSpotlights = spotlightItems.length > 0;

// Duplicate items if we have fewer than 6 to ensure smooth infinite loop
// For loop mode to work smoothly, we need at least 6 slides
const displayItems = spotlightItems.length < 6
  ? [
      ...spotlightItems.map((item, index) => ({ ...item, originalIndex: index })),
      ...spotlightItems.map((item, index) => ({ ...item, originalIndex: index })),
      ...spotlightItems.map((item, index) => ({ ...item, originalIndex: index }))
    ]
  : spotlightItems.map((item, index) => ({ ...item, originalIndex: index }));
---

{hasSpotlights && (
<section id="spotlight-carousel-section" class="py-16 md:py-20 lg:py-24 bg-gradient-to-b from-gray-50/50 to-white/50 overflow-hidden">
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div data-aos="fade-up-sm" class="mx-auto shrink-0 text-center lg:max-w-2xl mb-12 lg:mb-12">
      {sectionSubtitle && (
        <span
          class="bg-primary/5 border-gray-300 text-primary mb-2.5 inline-block rounded-full border px-5 py-px text-sm font-semibold"
        >
          {sectionSubtitle}
        </span>
      )}
      {sectionTitle && (
        <h2 class="text-h3 text-inherit mt-4" set:html={markdownify(sectionTitle)}>
        </h2>
      )}
    </div>

    <!-- Swiper Carousel -->
    <div class="spotlight-carousel-container w-full mx-auto relative">
      <div class="swiper spotlight-swiper" data-total-videos={spotlightItems.length} data-display-count={displayItems.length}>
        <div class="swiper-wrapper">
          {displayItems.map((item, index) => (
            <div class="swiper-slide" data-video-index={item.originalIndex}>
              <div class="relative w-full bg-black rounded-2xl overflow-hidden shadow-2xl" style="aspect-ratio: 16/9;">
                {item.isYouTube && item.videoId ? (
                  <!-- YouTube Video with Plyr -->
                  <div
                    class="plyr__video-embed spotlight-video"
                    data-plyr-provider="youtube"
                    data-plyr-embed-id={item.videoId}
                    data-index={index}
                    data-is-youtube="true"
                  >
                  </div>
                ) : (
                  <!-- Direct Video with Plyr -->
                  <video
                    class="spotlight-video plyr-video"
                    playsinline
                    loop
                    data-index={index}
                    data-is-youtube="false"
                  >
                    <source src={item.videoUrl} type="video/mp4" />
                  </video>
                )}
              </div>
            </div>
          ))}
        </div>

        <!-- Navigation Buttons -->
        <button class="swiper-button-prev spotlight-nav-btn" aria-label="Previous">
          <svg width="22" height="22" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
          </svg>
        </button>
        <button class="swiper-button-next spotlight-nav-btn" aria-label="Next">
          <svg width="22" height="22" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
          </svg>
        </button>

        <!-- Pagination -->
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </div>
</section>
)}

<!-- Import Swiper Styles -->
<style is:global>
  @import 'swiper/css';
  @import 'swiper/css/navigation';
  @import 'swiper/css/pagination';
  @import 'plyr/dist/plyr.css';
</style>

<style>
  .spotlight-carousel-container {
    padding: 0 10px;
    max-width: 100vw;
  }

  .spotlight-swiper {
    padding-bottom: 48px;
    overflow: visible;
  }

  /* Scope all swiper-slide styles to spotlight carousel only */
  .spotlight-swiper .swiper-slide {
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.4s ease;
    opacity: 0.4;
    transform: scale(0.85);
  }

  /* Active slide - center - LARGE! */
  .spotlight-swiper :global(.swiper-slide-active) {
    opacity: 1 !important;
    transform: scale(1) !important;
    z-index: 10;
  }

  /* Side slides - only partially visible */
  .spotlight-swiper :global(.swiper-slide-next),
  .spotlight-swiper :global(.swiper-slide-prev) {
    opacity: 0.5 !important;
    transform: scale(0.88) !important;
  }

  /* Custom navigation buttons - White circles with blue arrows */
  .spotlight-nav-btn {
    position: absolute !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 52px !important;
    height: 52px !important;
    background: rgba(255, 255, 255, 0.95) !important;
    backdrop-filter: blur(10px) !important;
    border-radius: 50% !important;
    border: 1px solid rgba(0, 0, 0, 0.15) !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    transition: all 0.2s ease !important;
    z-index: 30 !important;
    color: #00025d !important;
    opacity: 1 !important;
    visibility: visible !important;
    padding: 0 !important;
    box-sizing: border-box !important;
  }

  .spotlight-nav-btn:hover {
    transform: translateY(-50%) scale(1.05);
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .spotlight-nav-btn.swiper-button-prev {
    left: 10px;
  }

  .spotlight-nav-btn.swiper-button-next {
    right: 10px;
  }

  /* Remove default Swiper arrow */
  .spotlight-nav-btn::after {
    content: none;
  }

  /* Custom pagination - scoped to spotlight carousel only */
  .spotlight-swiper :global(.swiper-pagination) {
    bottom: 0;
  }

  .spotlight-swiper :global(.swiper-pagination-bullet) {
    width: 12px;
    height: 12px;
    background: rgba(0, 2, 93, 0.3);
    opacity: 1;
    transition: all 0.3s ease;
  }

  .spotlight-swiper :global(.swiper-pagination-bullet-active) {
    background: var(--primary, #00025d);
    width: 32px;
    border-radius: 6px;
  }

  /* Plyr customization */
  :global(.plyr) {
    border-radius: 1rem;
  }

  :global(.plyr__video-wrapper) {
    border-radius: 1rem;
  }

  :global(.plyr__controls) {
    background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
  }

  /* Mobile adjustments */
  @media (max-width: 1024px) {
    .spotlight-carousel-container {
      padding: 0 60px;
    }
  }

  @media (max-width: 768px) {
    .spotlight-carousel-container {
      padding: 0 40px;
    }

    .spotlight-nav-btn {
      width: 44px;
      height: 44px;
    }

    .spotlight-nav-btn svg {
      width: 20px;
      height: 20px;
    }

    .spotlight-nav-btn.swiper-button-prev {
      left: 8px;
    }

    .spotlight-nav-btn.swiper-button-next {
      right: 8px;
    }
  }

  @media (max-width: 640px) {
    .spotlight-carousel-container {
      padding: 0 24px;
    }

    .spotlight-nav-btn.swiper-button-prev {
      left: 4px;
    }

    .spotlight-nav-btn.swiper-button-next {
      right: 4px;
    }
  }
</style>

<script>
  import Swiper from 'swiper';
  import { Navigation, Pagination, Autoplay } from 'swiper/modules';
  import Plyr from 'plyr';

  // Initialize when DOM is ready
  function initSpotlightCarousel() {
    const swiperElement = document.querySelector('.spotlight-swiper') as HTMLElement;
    if (!swiperElement) {
      console.log('Swiper element not found');
      return;
    }

    const totalVideos = parseInt(swiperElement.getAttribute('data-total-videos') || '0');
    const displayCount = parseInt(swiperElement.getAttribute('data-display-count') || '0');
    console.log('Initializing carousel with', totalVideos, 'videos (', displayCount, 'displayed with duplicates)');

    // Track state
    let isInViewport = false;
    let currentPlayingIndex = -1;
    let playTimeoutId: number | null = null;
    let isTransitioning = false;

    // Initialize Plyr for all videos
    const players: Plyr[] = [];
    const videoElements = document.querySelectorAll('.spotlight-video');

    videoElements.forEach((element, index) => {
      const isYouTube = element.getAttribute('data-is-youtube') === 'true';

      const player = new Plyr(element, {
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'fullscreen'],
        autoplay: false,
        muted: true, // Start muted to comply with browser autoplay policies
        loop: { active: true },
        clickToPlay: true,
        youtube: {
          noCookie: true,
          rel: 0,
          showinfo: 0,
          iv_load_policy: 3,
          modestbranding: 1
        },
        vimeo: {
          byline: false,
          portrait: false,
          title: false
        }
      });

      // Track play/pause events to maintain state
      player.on('play', () => {
        console.log(`Player ${index} started playing`);
        // If a different video started playing, pause this one
        if (currentPlayingIndex !== -1 && currentPlayingIndex !== index) {
          console.log(`Different video playing, pausing player ${index}`);
          setTimeout(() => player.pause(), 50);
        }
      });

      player.on('pause', () => {
        console.log(`Player ${index} paused`);
      });

      player.on('ready', () => {
        console.log(`Player ${index} ready (YouTube: ${isYouTube})`);
      });

      players.push(player);
    });

    // Function to forcefully pause all videos
    const pauseAllVideos = () => {
      console.log('Pausing all videos');

      // Clear any pending play timeout
      if (playTimeoutId !== null) {
        clearTimeout(playTimeoutId);
        playTimeoutId = null;
      }

      players.forEach((player, idx) => {
        try {
          if (player.playing) {
            player.pause();
            console.log(`Paused player ${idx}`);
          }
          // Force stop for YouTube videos
          if (player.source && (player.source as any).type === 'youtube') {
            player.stop();
          }
        } catch (e: any) {
          console.log(`Error pausing player ${idx}:`, e);
        }
      });

      currentPlayingIndex = -1;
    };

    // Function to play the active video
    const playActiveVideo = (swiperInstance: Swiper, delay = 400) => {
      if (!isInViewport) {
        console.log('Section not in viewport, skipping autoplay');
        return;
      }

      if (isTransitioning) {
        console.log('Transition in progress, skipping play');
        return;
      }

      // Clear any previous timeout
      if (playTimeoutId !== null) {
        clearTimeout(playTimeoutId);
        playTimeoutId = null;
      }

      const activeSlide = swiperInstance.slides[swiperInstance.activeIndex];
      if (!activeSlide) {
        console.log('No active slide found');
        return;
      }

      const activeVideoElement = activeSlide.querySelector('.spotlight-video') as HTMLElement;
      if (!activeVideoElement) {
        console.log('No video element in active slide');
        return;
      }

      const activePlayerIndex = Array.from(videoElements).indexOf(activeVideoElement);
      const isYouTube = activeVideoElement.getAttribute('data-is-youtube') === 'true';

      console.log('Play attempt - Active player index:', activePlayerIndex, 'is YouTube:', isYouTube);

      if (activePlayerIndex < 0 || !players[activePlayerIndex]) {
        console.log('Invalid player index or player not found');
        return;
      }

      // Don't replay if already playing
      if (currentPlayingIndex === activePlayerIndex && players[activePlayerIndex].playing) {
        console.log('Video already playing, skipping');
        return;
      }

      // Schedule play after delay
      playTimeoutId = window.setTimeout(() => {
        try {
          const player = players[activePlayerIndex];

          // Ensure video is muted for autoplay
          player.muted = true;

          // Restart video from beginning
          player.currentTime = 0;

          // Play the video
          player.play().then(() => {
            console.log(`Successfully started playing video ${activePlayerIndex}`);
            currentPlayingIndex = activePlayerIndex;
          }).catch((e: any) => {
            console.log(`Failed to play video ${activePlayerIndex}:`, e);
            currentPlayingIndex = -1;
          });
        } catch (e: any) {
          console.log('Error in play attempt:', e);
        }

        playTimeoutId = null;
      }, delay);
    };

    // Calculate loop settings based on number of slides
    const shouldLoop = displayCount >= 3;
    const loopSlides = Math.max(3, Math.ceil(displayCount / 2));

    console.log('Loop enabled:', shouldLoop, 'Loop additional slides:', loopSlides);

    // Initialize Swiper
    const swiper = new Swiper('.spotlight-swiper', {
      modules: [Navigation, Pagination, Autoplay],
      slidesPerView: 1.35,
      spaceBetween: 24,
      centeredSlides: true,
      loop: shouldLoop,
      loopAdditionalSlides: loopSlides,
      loopedSlides: displayCount,
      watchSlidesProgress: true,
      slideToClickedSlide: true,
      speed: 600,
      autoplay: shouldLoop ? {
        delay: 30000, // 30 seconds delay between slides
        disableOnInteraction: false,
        pauseOnMouseEnter: true,
      } : false,
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
        dynamicBullets: false,
        renderBullet: function (index, className) {
          // Only show bullets for original videos, not duplicates
          if (index < totalVideos) {
            return `<span class="${className}"></span>`;
          }
          return '';
        },
      },
      breakpoints: {
        640: {
          slidesPerView: 1.1,
          spaceBetween: 12,
          loopAdditionalSlides: 2,
        },
        768: {
          slidesPerView: 1.2,
          spaceBetween: 16,
          loopAdditionalSlides: 2,
        },
        1024: {
          slidesPerView: 1.3,
          spaceBetween: 20,
          loopAdditionalSlides: 3,
        },
        1280: {
          slidesPerView: 1.35,
          spaceBetween: 24,
          loopAdditionalSlides: 3,
        },
      },
      on: {
        slideChangeTransitionStart: function(this: Swiper) {
          console.log('Transition started');
          isTransitioning = true;
          // Immediately pause all videos when transition starts
          pauseAllVideos();
        },
        slideChangeTransitionEnd: function(this: Swiper) {
          console.log('Transition ended - realIndex:', this.realIndex, 'activeIndex:', this.activeIndex);
          isTransitioning = false;

          // Find the centered/active slide
          const activeSlide = this.slides[this.activeIndex];
          const activeVideoIndex = activeSlide ? parseInt(activeSlide.getAttribute('data-video-index') || '0') : 0;

          console.log('Active video index:', activeVideoIndex);

          // Update pagination bullets manually
          const bullets = document.querySelectorAll('.swiper-pagination-bullet');
          bullets.forEach((bullet, index) => {
            if (index === activeVideoIndex) {
              bullet.classList.add('swiper-pagination-bullet-active');
            } else {
              bullet.classList.remove('swiper-pagination-bullet-active');
            }
          });

          // Play the active video only if in viewport
          if (isInViewport) {
            playActiveVideo(this);
          }
        },
        init: function(this: Swiper) {
          console.log('Swiper initialized with', displayCount, 'slides');
          // Set initial pagination
          const activeSlide = this.slides[this.activeIndex];
          const activeVideoIndex = activeSlide ? parseInt(activeSlide.getAttribute('data-video-index') || '0') : 0;
          const bullets = document.querySelectorAll('.swiper-pagination-bullet');
          bullets.forEach((bullet, index) => {
            if (index === activeVideoIndex) {
              bullet.classList.add('swiper-pagination-bullet-active');
            } else {
              bullet.classList.remove('swiper-pagination-bullet-active');
            }
          });
        }
      }
    });

    console.log('Swiper instance:', swiper);

    // Set up Intersection Observer to handle autoplay on viewport entry
    const section = document.getElementById('spotlight-carousel-section');
    console.log('Spotlight section found:', section ? 'Yes' : 'No');

    if (section) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            console.log('Intersection change - isIntersecting:', entry.isIntersecting, 'ratio:', entry.intersectionRatio.toFixed(2));

            if (entry.isIntersecting && entry.intersectionRatio >= 0.3) {
              if (!isInViewport) {
                console.log('Spotlight section entered viewport - starting autoplay');
                isInViewport = true;
                // Wait for any transitions to complete
                setTimeout(() => {
                  if (isInViewport && !isTransitioning) {
                    playActiveVideo(swiper, 200);
                  }
                }, 300);
              }
            } else {
              if (isInViewport) {
                console.log('Spotlight section left viewport - pausing all');
                isInViewport = false;
                pauseAllVideos();
              }
            }
          });
        },
        {
          threshold: [0, 0.3, 0.5, 1], // Multiple thresholds for better detection
          rootMargin: '0px'
        }
      );

      observer.observe(section);

      // Check if section is already in viewport on page load
      setTimeout(() => {
        const rect = section.getBoundingClientRect();
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const sectionHeight = rect.height;
        const visibleHeight = Math.min(rect.bottom, viewportHeight) - Math.max(rect.top, 0);
        const visibilityRatio = Math.max(0, visibleHeight / sectionHeight);

        console.log('Initial visibility check - visibility ratio:', visibilityRatio.toFixed(2));

        if (visibilityRatio >= 0.3) {
          console.log('Section is already in viewport on load');
          isInViewport = true;
          // Wait for swiper to be fully ready
          setTimeout(() => {
            if (isInViewport && !isTransitioning) {
              playActiveVideo(swiper, 800);
            }
          }, 500);
        }
      }, 200);
    }
  }

  // Run initialization
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSpotlightCarousel);
  } else {
    initSpotlightCarousel();
  }
</script>
