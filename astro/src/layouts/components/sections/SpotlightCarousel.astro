---
// Spotlight Carousel Section
// Full-width carousel with 2:1 ratio cards
import { markdownify } from "@/lib/utils/textConverter";
import CustomButton from "../CustomButton.astro";
import { getSpotlights } from "@/lib/utils/strapiApi";

interface SpotlightItem {
  title: string;
  date?: string;
  subtitle: string;
  description: string;
  buttonText: string;
  buttonLink: string;
  image: string;
  tag?: string;
}

// Fetch spotlights from Strapi
const strapiSpotlights = await getSpotlights();

// Convert Strapi data to component format
const spotlightItems: SpotlightItem[] = strapiSpotlights.map(spotlight => ({
  tag: spotlight.tag,
  date: spotlight.date,
  title: spotlight.title,
  subtitle: spotlight.subtitle || '',
  description: spotlight.description,
  buttonText: spotlight.buttonText,
  buttonLink: spotlight.buttonLink,
  image: spotlight.image?.url.startsWith('http') ? spotlight.image.url : `http://localhost:1337${spotlight.image?.url || ''}`
}));

// Section header content
const sectionTitle = "Don't Miss Out on **Upcoming Events**";
const sectionSubtitle = "In The Spotlight";
---

<section class="py-16 md:py-20 lg:py-24 bg-gradient-to-b from-gray-50/50 to-white/50 overflow-hidden">
  <div class="container mx-auto px-4">
    <!-- Section Header -->
    <div data-aos="fade-up-sm" class="mx-auto shrink-0 text-center lg:max-w-2xl mb-12 lg:mb-12">
      {sectionSubtitle && (
        <span
          class="bg-primary/5 border-secondary text-primary mb-2.5 inline-block rounded-full border px-5 py-px text-sm font-semibold"
        >
          {sectionSubtitle}
        </span>
      )}
      {sectionTitle && (
        <h2 class="text-h3 text-inherit mt-4" set:html={markdownify(sectionTitle)}>
        </h2>
      )}
    </div>

    <!-- Carousel Container -->
    <div class="relative spotlight-carousel">
      <!-- Carousel Wrapper -->
      <div class="spotlight-carousel-track flex transition-transform duration-500 ease-out">
        {spotlightItems.map((item, index) => (
          <div class="spotlight-slide w-full flex-shrink-0 px-2" data-index={index}>
            <!-- 3:1 Ratio Card -->
            <div class="relative w-full bg-gradient-to-br from-primary via-primary/90 to-primary/80 rounded-3xl overflow-hidden shadow-2xl group" style="aspect-ratio: 3/1;">
              <div class="absolute inset-0 flex flex-col lg:flex-row">
                <!-- Content Section - Left Side -->
                <div class="flex-1 p-8 lg:p-16 flex flex-col justify-center text-white z-10 lg:pl-20">
                  {item.tag && (
                    <div class="mb-4">
                      <span class="text-xs lg:text-sm font-semibold tracking-[0.2em] uppercase opacity-90">
                        {item.tag}
                      </span>
                    </div>
                  )}
                  
                  {item.date && (
                    <div class="mb-4">
                      <span class="text-sm lg:text-base font-medium opacity-90">
                        {item.date}
                      </span>
                    </div>
                  )}
                  
                  <h2 class="text-xl lg:text-2xl xl:text-3xl font-bold mb-4 lg:mb-6 leading-tight text-white">
                    {item.title}
                  </h2>
                  
                  <p class="text-base lg:text-lg opacity-90 mb-6 lg:mb-8 leading-relaxed max-w-xl">
                    {item.description}
                  </p>
                  
                  <div>
                    <CustomButton
                      label={item.buttonText}
                      url={item.buttonLink}
                      variant="outline-white"
                      size="md"
                      showIcon="true"
                      hoverEffect="creative-fill"
                    />
                  </div>
                </div>
                
                <!-- Image Section - Right Side (hidden on mobile) -->
                <div class="hidden lg:flex flex-1 relative">
                  <div class="absolute inset-0 bg-gradient-to-l from-transparent via-primary/20 to-primary/40 z-10"></div>
                  <img
                    src={item.image}
                    alt={item.title}
                    class="w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity duration-500"
                  />
                  <!-- Decorative Text Overlay -->
                  <div class="absolute inset-0 flex items-center justify-center z-20 pointer-events-none opacity-20">
                    <span class="text-[12rem] font-bold text-white/10" style="letter-spacing: -0.05em;">
                      {item.tag?.split(' ')[0] || ''}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>
      
      <!-- Navigation Arrows -->
      <button
        class="spotlight-prev absolute left-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 lg:w-12 lg:h-12 bg-white/90 hover:bg-white rounded-full shadow-xl flex items-center justify-center text-primary transition-all duration-300 hover:scale-110"
        aria-label="Previous slide"
      >
        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>
      
      <button
        class="spotlight-next absolute right-4 top-1/2 -translate-y-1/2 z-20 w-10 h-10 lg:w-12 lg:h-12 bg-white/90 hover:bg-white rounded-full shadow-xl flex items-center justify-center text-primary transition-all duration-300 hover:scale-110"
        aria-label="Next slide"
      >
        <svg class="w-5 h-5 lg:w-6 lg:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
      
      <!-- Dots Indicator -->
      <div class="flex justify-center gap-3 mt-8">
        {spotlightItems.map((_, index) => (
          <button
            class="spotlight-dot w-3 h-3 rounded-full transition-all duration-300"
            class:list={[
              index === 0 ? "bg-primary w-8" : "bg-gray-300 hover:bg-gray-400"
            ]}
            data-index={index}
            aria-label={`Go to slide ${index + 1}`}
          ></button>
        ))}
      </div>
    </div>
  </div>
</section>

<script>
  // Spotlight Carousel Script
  class SpotlightCarousel {
    private track: HTMLElement | null;
    private slides: NodeListOf<HTMLElement>;
    private dots: NodeListOf<HTMLElement>;
    private prevBtn: HTMLElement | null;
    private nextBtn: HTMLElement | null;
    private currentIndex: number = 0;
    private autoplayInterval: number | null = null;
    private isTransitioning: boolean = false;

    constructor() {
      this.track = document.querySelector('.spotlight-carousel-track');
      this.slides = document.querySelectorAll('.spotlight-slide');
      this.dots = document.querySelectorAll('.spotlight-dot');
      this.prevBtn = document.querySelector('.spotlight-prev');
      this.nextBtn = document.querySelector('.spotlight-next');
      
      this.init();
    }

    init() {
      if (!this.track || this.slides.length === 0) return;

      // Event listeners
      this.prevBtn?.addEventListener('click', () => this.prev());
      this.nextBtn?.addEventListener('click', () => this.next());
      
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goToSlide(index));
      });

      // Touch/Swipe support
      let startX = 0;
      let currentX = 0;
      let isDragging = false;

      this.track.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
        this.pauseAutoplay();
      });

      this.track.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
      });

      this.track.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        const diff = startX - currentX;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            this.next();
          } else {
            this.prev();
          }
        }
        
        this.startAutoplay();
      });

      // Start autoplay
      this.startAutoplay();
      
      // Pause on hover
      const carousel = document.querySelector('.spotlight-carousel');
      carousel?.addEventListener('mouseenter', () => this.pauseAutoplay());
      carousel?.addEventListener('mouseleave', () => this.startAutoplay());
    }

    goToSlide(index: number) {
      if (this.isTransitioning || !this.track) return;
      
      this.isTransitioning = true;
      this.currentIndex = index;
      
      const offset = -index * 100;
      this.track.style.transform = `translateX(${offset}%)`;
      
      this.updateDots();
      
      setTimeout(() => {
        this.isTransitioning = false;
      }, 500);
    }

    next() {
      const nextIndex = (this.currentIndex + 1) % this.slides.length;
      this.goToSlide(nextIndex);
    }

    prev() {
      const prevIndex = (this.currentIndex - 1 + this.slides.length) % this.slides.length;
      this.goToSlide(prevIndex);
    }

    updateDots() {
      this.dots.forEach((dot, index) => {
        if (index === this.currentIndex) {
          dot.classList.add('bg-primary', 'w-8');
          dot.classList.remove('bg-gray-300', 'w-3');
        } else {
          dot.classList.remove('bg-primary', 'w-8');
          dot.classList.add('bg-gray-300', 'w-3');
        }
      });
    }

    startAutoplay() {
      this.pauseAutoplay();
      this.autoplayInterval = window.setInterval(() => {
        this.next();
      }, 5000);
    }

    pauseAutoplay() {
      if (this.autoplayInterval) {
        clearInterval(this.autoplayInterval);
        this.autoplayInterval = null;
      }
    }
  }

  // Initialize carousel when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new SpotlightCarousel();
    });
  } else {
    new SpotlightCarousel();
  }
</script>

<style>
  .spotlight-carousel {
    position: relative;
  }

  .spotlight-carousel-track {
    display: flex;
    transition: transform 0.5s ease-out;
  }

  .spotlight-slide {
    min-width: 100%;
  }

  /* Smooth transitions */
  .spotlight-dot {
    transition: all 0.3s ease;
  }

  /* Mobile optimizations */
  @media (max-width: 1024px) {
    .spotlight-slide {
      padding: 0 0.5rem;
    }
  }
</style>
