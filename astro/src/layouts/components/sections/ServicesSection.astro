---
import type { Section } from "@/types";
import { getEntryCTM } from "@/lib/contentParser.astro";
import ServiceCard from "@/layouts/components/cards/ServiceCard.astro";
import { markdownify } from "@/lib/utils/textConverter";
import config from ".astro/config.generated.json" assert { type: "json" };
import { getCollectionCTM } from "@/lib/contentParser.astro";
import CustomButton from "../CustomButton.astro";
import overrideObjects from "@/lib/utils/overrideObjects";
import Icons from "@/helpers/Icons.astro";
import { getTrainings, getConsultants } from "@/lib/utils/strapiApi";

// Type for service section data
export type sectionType = Section & {
  limit?: number | boolean;
  cta?: "link" | "slider-nav";
  colorScheme?: "light" | "dark";
  showServicesAs?: "slider" | "static";
  creativeShape?: { enable: boolean; position: "top" | "bottom" };
};
type Props = {
  content?: sectionType;
};

// Fetching the default content for the service section
let defaultContent = (
  await getEntryCTM("sections", "services-section", Astro.currentLocale)
)?.data as sectionType;

// Enables content customization (e.g., title, description) with a fallback to 'defaultContent' if not provided.
// The 'content' prop should match the structure of 'defaultContent'.
// Allows using this section with different content across multiple pages.
// If 'content' is missing, 'defaultContent' will be used.
let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as sectionType;

// Extracting required values from 'content' object
let {
  cta,
  limit,
  title,
  enable,
  button,
  subtitle,
  colorScheme,
  creativeShape,
  showServicesAs,
} = actualContent as sectionType;

if (!enable) return;

// Fetch trainings and consultants from Strapi
const trainings = await getTrainings();
const consultants = await getConsultants();

// Combine trainings and consultants as services
let services = [
  ...trainings.slice(0, 2).map(training => ({
    ...training,
    type: 'training',
    slug: training.slug,
    title: training.title,
    description: training.description,
    image: training.image
  })),
  ...consultants.slice(0, 2).map(consultant => ({
    ...consultant,
    type: 'consultant',
    slug: consultant.slug,
    title: consultant.title,
    description: consultant.description,
    image: consultant.image
  }))
];

// Limit the number of services to be displayed
services =
  limit && showServicesAs !== "slider"
    ? services.slice(0, limit as number)
    : services;
---

<section
  class:list={[
    {
      "overflow-hidden":
        creativeShape?.enable && creativeShape?.position !== "top",
    },
    "pt-0 -mt-8 md:-mt-12 pb-4 md:pb-8",
  ]}>
  <div
    class:list={[
      "flex flex-col justify-start gap-12 md:gap-16 py-0 md:py-8",
      { "bg-theme-dark": colorScheme === "dark" },
    ]}>
    <div class="container">
      <div
        class="flex flex-col flex-wrap justify-between gap-8 lg:flex-row lg:items-center">
        <div class="shrink-0 lg:lg:max-w-2xl" data-aos="fade-up-sm">
          {
            subtitle && (
              <span
                class:list={[
                  "mb-2.5 inline-block rounded-full border px-5 py-px",
                  colorScheme === "dark"
                    ? "border-white/5 bg-white/5 text-white"
                    : "bg-primary/5 border-secondary text-primary",
                ]}
                set:html={markdownify(subtitle)}
              />
            )
          }
          {
            title && (
              <h2
                class:list={[
                  "text-h3",
                  colorScheme === "dark" ? "text-white" : "text-dark",
                ]}
                set:html={markdownify(title)}
              />
            )
          }
        </div>

        {
          button?.enable && cta === "link" ? (
            // CTA button
            <div data-aos="fade-up-sm" data-aos-delay="200">
              <CustomButton {...button} />
            </div>
          ) : showServicesAs === "slider" && cta === "slider-nav" ? (
            // Slider Controls
            <div class="flex gap-8" data-aos="fade-up-sm" data-aos-delay="200">
              <button class="services-slider-btn-prev bg-secondary hover:bg-primary group/slider-control relative flex h-14 w-14 items-center justify-center rounded-full transition duration-300">
                <Icons
                  icon="ChevronLeft"
                  class="text-primary group-hover/slider-control:text-secondary h-7 w-7 transition duration-300 group-hover/slider-control:-translate-x-1"
                />
              </button>
              <button class="services-slider-btn-next bg-secondary hover:bg-primary group/slider-control relative flex h-14 w-14 rotate-180 items-center justify-center rounded-full transition duration-300">
                <Icons
                  icon="ChevronLeft"
                  class="text-primary group-hover/slider-control:text-secondary h-7 w-7 transition duration-300 group-hover/slider-control:-translate-x-1"
                />
              </button>
            </div>
          ) : null
        }
      </div>
    </div>
    {
      creativeShape?.enable ? (
        <div
          class:list={[
            "has-light-shape relative after:absolute after:inset-x-0 after:h-screen after:w-full",
            {
              "pb-4": showServicesAs === "slider",
            },
            {
              "after:top-68.25 after:bg-stone-50 after:md:top-72":
                creativeShape?.position === "bottom",
            },
            {
              "after:bg-theme-light after:bottom-[calc(100%-18rem)] after:-z-20":
                creativeShape?.position === "top",
            },
          ]}>
          <div class="relative z-10 container pb-8 md:pb-12">
            {services && showServicesAs === "static" ? (
              <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-4">
                {services.map((service: any, index: number) => (
                  <div
                    data-aos="fade-up-sm"
                    data-aos-delay={index * 100}
                    class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100">
                    {service.image && (
                      <div class="aspect-[16/9] overflow-hidden">
                        <img
                          src={service.image.url.startsWith('http') ? service.image.url : `http://localhost:1337${service.image.url}`}
                          alt={service.title}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        />
                      </div>
                    )}
                    <div class="p-6">
                      <div class="flex items-center justify-between mb-3">
                        <h3 class="text-h5 text-primary font-semibold">{service.title}</h3>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary capitalize">
                          {service.type}
                        </span>
                      </div>
                      <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">
                        {service.description?.length > 120 ? service.description.substring(0, 120) + '...' : service.description}
                      </p>
                      <div class="mt-4">
                        <a
                          href={service.type === 'training' ? `/services/training/${service.slug}` : `/services/consulting/${service.slug}`}
                          class="inline-flex items-center text-primary font-medium hover:text-primary/80 transition-colors text-sm">
                          Learn More
                          <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                          </svg>
                        </a>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div class="swiper services-swiper w-full">
                <div class="swiper-wrapper">
                  {services &&
                    services.map((service: any, index: number) => (
                      <div class="swiper-slide h-auto! p-2">
                        <div class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 min-h-full">
                          {service.image && (
                            <div class="aspect-[16/9] overflow-hidden">
                              <img
                                src={service.image.url.startsWith('http') ? service.image.url : `http://localhost:1337${service.image.url}`}
                                alt={service.title}
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                              />
                            </div>
                          )}
                          <div class="p-6">
                            <div class="flex items-center justify-between mb-3">
                              <h3 class="text-h5 text-primary font-semibold">{service.title}</h3>
                              <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary capitalize">
                                {service.type}
                              </span>
                            </div>
                            <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">
                              {service.description?.length > 200 ? service.description.substring(0, 200) + '...' : service.description}
                            </p>
                            <div class="mt-4">
                              <a
                                href={service.type === 'training' ? `/services/training/${service.slug}` : `/services/consulting/${service.slug}`}
                                class="inline-flex items-center text-primary font-medium hover:text-primary/80 transition-colors text-sm">
                                Learn More
                                <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                              </a>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              </div>
            )}
          </div>
        </div>
      ) : (
        <div class="container">
          {services && showServicesAs === "static" ? (
            <div class="grid gap-5 md:grid-cols-2 lg:grid-cols-4">
              {services.map((service: any, index: number) => (
                <div
                  data-aos="fade-up-sm"
                  data-aos-delay={index * 100}
                  class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100">
                  {service.image && (
                    <div class="aspect-[16/9] overflow-hidden">
                      <img
                        src={service.image.url.startsWith('http') ? service.image.url : `http://localhost:1337${service.image.url}`}
                        alt={service.title}
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                      />
                    </div>
                  )}
                  <div class="p-6">
                    <div class="flex items-center justify-between mb-3">
                      <h3 class="text-h5 text-primary font-semibold">{service.title}</h3>
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary capitalize">
                        {service.type}
                      </span>
                    </div>
                    <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">
                      {service.description?.length > 200 ? service.description.substring(0, 200) + '...' : service.description}
                    </p>
                    <div class="mt-4">
                      <a
                        href={service.type === 'training' ? `/services/training/${service.slug}` : `/services/consulting/${service.slug}`}
                        class="inline-flex items-center text-primary font-medium hover:text-primary/80 transition-colors text-sm">
                        Learn More
                        <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                      </a>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="swiper services-swiper w-full">
              <div class="swiper-wrapper">
                {services &&
                  services.map((service: any, index: number) => (
                    <div class="swiper-slide h-auto! p-2">
                      <div class="group bg-white rounded-2xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 min-h-full">
                        {service.image && (
                          <div class="aspect-[16/9] overflow-hidden">
                            <img
                              src={service.image.url.startsWith('http') ? service.image.url : `http://localhost:1337${service.image.url}`}
                              alt={service.title}
                              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                            />
                          </div>
                        )}
                        <div class="p-6">
                          <div class="flex items-center justify-between mb-3">
                            <h3 class="text-h5 text-primary font-semibold">{service.title}</h3>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary/10 text-primary capitalize">
                              {service.type}
                            </span>
                          </div>
                          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">
                            {service.description?.length > 120 ? service.description.substring(0, 120) + '...' : service.description}
                          </p>
                          <div class="mt-4">
                            <a
                              href={service.type === 'training' ? `/services/training/${service.slug}` : `/services/consulting/${service.slug}`}
                              class="inline-flex items-center text-primary font-medium hover:text-primary/80 transition-colors text-sm">
                              Learn More
                              <svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                              </svg>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            </div>
          )}
        </div>
      )
    }
  </div>
  <script>
    window.addEventListener("load", async function () {
      const { Swiper } = await import("swiper");
      const { EffectFade, Navigation, Controller, Autoplay } = await import(
        "swiper/modules"
      );

      // Initialize content Swiper with navigation
      new Swiper(".services-swiper", {
        modules: [EffectFade, Navigation, Controller, Autoplay],
        speed: 1000,
        spaceBetween: 20,
        breakpoints: {
          540: {
            slidesPerView: 1,
          },
          768: {
            slidesPerView: 2,
          },
          1024: {
            slidesPerView: 3,
          },
        },
        loop: true,
        autoplay: {
          delay: 3000,
        },
        navigation: {
          nextEl: ".services-slider-btn-next",
          prevEl: ".services-slider-btn-prev",
        },
      });
    });
  </script>
</section>
