---
import { getEntryCTM } from "@/lib/contentParser.astro";
import TeamCard from "@/layouts/components/cards/TeamCard.astro";
import type { Section, TeamMember } from "@/types";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import { markdownify } from "@/lib/utils/textConverter";
import CustomButton from "../CustomButton.astro";

// Type for this section data
type sectionType = Section & {
  layout?: "horizontal" | "vertical"; // Default is 'vertical'
  leadershipTeam?: boolean;
  quote?: {
    enable: boolean;
    value: string;
    attribution: string;
  };
};
type Props = {
  content?: sectionType;
};

// Fetching the default content for the this section
let defaultContent = (
  await getEntryCTM("sections", "our-team", Astro.currentLocale)
)?.data as sectionType;

// Enables content customization (e.g., title, description) with a fallback to 'defaultContent' if not provided.
// The 'content' prop should match the structure of 'defaultContent'.
// Allows using this section with different content across multiple pages.
// If 'content' is missing, 'defaultContent' will be used.
let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as sectionType;

// Extracting required values from 'content' object
let {
  enable = true,
  title,
  description,
  subtitle,
  button,
  limit,
  quote,
  leadershipTeam,
  layout,
} = actualContent as sectionType;

let { members }: { members: TeamMember[] } = (
  await getEntryCTM("team", "-index", Astro.currentLocale)
)?.data;

// If leadershipTeam true, remove the regular members else remove the leadership team members from regular list
if (leadershipTeam) {
  members = members.filter((member) => member.leadershipTeam);
} else {
  members = members.filter((member) => !member.leadershipTeam);
}

// Limit the number of team members to be displayed
members = limit && members ? members.slice(0, limit as number) : members;

// Check if section layout is horizontal
const isHorizontal = layout === "horizontal";
---

{
  enable && (
    <section>
      <div
        class:list={[
          "container",
          {
            "grid place-items-stretch gap-10 lg:grid-cols-2": isHorizontal,
          },
        ]}>
        <div
          class:list={[
            "flex flex-wrap items-center justify-between gap-6 overflow-x-hidden lg:flex-nowrap",
          ]}>
          <div class="lg:max-w-2xl" data-aos="fade-right-sm">
            {subtitle && (
              <span
                class="bg-primary/5 border-secondary text-primary mb-2.5 inline-block rounded-full border px-5 py-px"
                set:html={markdownify(subtitle)}
              />
            )}
            {title && (
              <h2 class="text-h3 text-inherit" set:html={markdownify(title)} />
            )}
            {description && (
              <p class="mt-6" set:html={markdownify(description, true)} />
            )}
            {quote && quote.enable && (
              <blockquote class="border-primary mt-5 max-w-xl border-l py-1 pl-5">
                <p class="opacity-70" set:html={quote.value} />
                <p class="mt-3 text-xs" set:html={quote.attribution} />
              </blockquote>
            )}
          </div>
          {button && button.enable && (
            <div data-aos="fade-right-sm" data-aos-delay="200">
              <CustomButton {...button} />
            </div>
          )}
        </div>
        {members && members.length > 0 && (
          <div
            class:list={[
              "grid gap-6",
              isHorizontal
                ? "md:grid-cols-2 md:grid-rows-2 md:place-items-center"
                : "mt-8 md:grid-cols-2 lg:mt-16 lg:grid-cols-4",
            ]}>
            {members.map((item, index) => (
              <TeamCard
                content={item}
                imageSize={isHorizontal && index !== 0 ? "md" : "lg"}
                class:list={[{ "md:row-span-2": index === 0 && isHorizontal }]}
                data-aos="fade-up-sm"
                data-aos-delay={index * 100}
              />
            ))}
          </div>
        )}
      </div>
    </section>
  )
}
