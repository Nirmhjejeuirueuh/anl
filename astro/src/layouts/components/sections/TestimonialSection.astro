---
import Marquee from "@/layouts/components/widgets/Marquee.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import type { Section } from "@/types";
import { markdownify } from "@/lib/utils/textConverter";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import TestimonialCard from "@/layouts/components/cards/TestimonialCard.astro";
import CustomButton from "../CustomButton.astro";
import type { marqueeConfig } from "@/content.config";
import type { TypeOf } from "astro:schema";
import { getTestimonials } from "@/lib/utils/strapiApi";

// Type for this section data
export type sectionType = Section & {
  marquee: TypeOf<typeof marqueeConfig>;
};

// Fetching the default content for the this section
let defaultContent = (
  await getEntryCTM("sections", "testimonial-section", Astro.currentLocale)
)?.data as sectionType;

// Enables content customization (e.g., title, description) with a fallback to 'defaultContent' if not provided.
// The 'content' prop should match the structure of 'defaultContent'.
// Allows using this section with different content across multiple pages.
// If 'content' is missing, 'defaultContent' will be used.
let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as sectionType;

// Fetch testimonials from Strapi
const testimonials = await getTestimonials();

// Sort testimonials by order
const sortedTestimonials = testimonials.sort((a, b) => (a.order || 0) - (b.order || 0));

// Helper function to process testimonial data
const processTestimonial = (testimonial: any) => ({
  ...testimonial,
  companyLogo: testimonial.companyLogo ? {
    ...testimonial.companyLogo,
    url: testimonial.companyLogo.url.startsWith('http') ? testimonial.companyLogo.url : `http://localhost:1337${testimonial.companyLogo.url}`
  } : undefined,
  avatar: testimonial.avatar ? {
    ...testimonial.avatar,
    url: testimonial.avatar.url.startsWith('http') ? testimonial.avatar.url : `http://localhost:1337${testimonial.avatar.url}`
  } : undefined
});

// Extracting required values from 'content' object
const sectionData: sectionType = actualContent as sectionType;
const { enable, title, subtitle, button, marquee } = sectionData;
---

{
  enable && (
    <section class="py-16 md:py-20 lg:py-24">
      <div class="container-fluid">
        <div class="row justify-content-center">
          <div class="col-xl-10">
            <div class="text-center mb-5">
              {subtitle && (
                <span class="bg-primary/5 border-gray-300 text-primary mb-2.5 inline-block rounded-full border px-5 py-px text-sm font-semibold">
                  {subtitle}
                </span>
              )}
              {title && (
                <h2 class="text-h3 text-inherit mt-4" set:html={markdownify(title)} />
              )}
            </div>
          </div>

          <div class="col-xl-10">
            {button && button.enable && (
              <div class="text-center mt-5">
                <CustomButton {...button} />
              </div>
            )}
          </div>
        </div>

        <div class="relative" data-aos="fade-up-sm" data-aos-delay="300">
          <div
            class="testimonial-gradient-bg [--accent-color:--color-accent]"
            aria-hidden="true"
          />
          <div class="relative mt-12 flex overflow-x-hidden md:mt-16">
            <Marquee
              class="items-stretch"
              marqueeElements={sortedTestimonials.length}
              {...marquee}
            >
              {sortedTestimonials.map((testimonial) => (
                <div class="min-w-(--marquee-element-width-responsive) h-full px-4 md:min-w-(--marquee-element-width)">
                  <TestimonialCard class="h-full" content={{
                    enable: true,
                    testimonial: processTestimonial(testimonial)
                  }} />
                </div>
              ))}
              {sortedTestimonials.map((testimonial) => (
                <div
                  class="min-w-(--marquee-element-width-responsive) h-full px-4 md:min-w-(--marquee-element-width)"
                  aria-hidden="true"
                >
                  <TestimonialCard class="h-full" content={{
                    enable: true,
                    testimonial: processTestimonial(testimonial)
                  }} />
                </div>
              ))}
            </Marquee>
          </div>
        </div>
      </div>
    </section>
  )
}
