---
import { toSentenceCase } from "@/lib/utils/textConverter";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import {
  getLocaleUrlCTM,
  useTranslations,
} from "@/lib/utils/i18nUtils.ts";
import CustomButton from "../CustomButton.astro";
import Icons from "@/helpers/Icons.astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  content: CollectionEntry<"services"> | CollectionEntry<"courses">;
  class?: string;
  showImage?: boolean;
}

const { content, class: className, showImage = true, ...rest } = Astro.props;
const t = await useTranslations(Astro.currentLocale as string);
const { image, icon, title, description } = content.data;

// Only courses have category, moduleCode, and trainingDays
const category = 'category' in content.data ? content.data.category : undefined;
const moduleCode = 'moduleCode' in content.data ? content.data.moduleCode : undefined;
const trainingDays = 'trainingDays' in content.data ? content.data.trainingDays : undefined;

let slug = getLocaleUrlCTM(content.id, Astro.currentLocale, content.collection);
---

<div class:list={["bg-white h-full flex flex-col", className]} {...rest}>
  <div class="relative">
    {
      image && showImage && (
        <OptimizedImage
          src={image}
          alt={toSentenceCase("Image about " + title)}
          width={416}
          height={288}
          class="h-72 w-full min-w-full object-cover"
        />
      )
    }
  </div>
  <div class="px-8 pt-10 pb-10 flex flex-col h-full">
    <div class="flex items-center gap-3 mb-4">
      {
        icon && (
          <div class="bg-primary flex h-12 w-12 items-center justify-center rounded-full fill-white transition duration-300 flex-shrink-0">
            <Icons
              icon={icon as any}
              class="h-6 w-6 stroke-1 text-white transition duration-300"
            />
          </div>
        )
      }
      {
        title && (
          <h3
            class="text-h4 after:bg-primary relative inline-block pb-2 opacity-80 after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-10"
            set:html={title}
          />
        )
      }
    </div>

    <!-- Course Information -->
    {(category || moduleCode || trainingDays) && (
      <div class="flex flex-wrap gap-3 mb-3 text-xs">
        {category && (
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-[#00025d]/10 text-[#00025d] rounded-full">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
            </svg>
            {category}
          </span>
        )}
        {moduleCode && (
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-[#FFEB3B]/10 text-[#14342B] rounded-full">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            {moduleCode}
          </span>
        )}
        {trainingDays && (
          <span class="inline-flex items-center gap-1 px-2 py-1 bg-[#43b14b]/10 text-[#43b14b] rounded-full">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {trainingDays} day{trainingDays > 1 ? 's' : ''}
          </span>
        )}
      </div>
    )}

    {description && <p class="text-text-default opacity-80 flex-1" set:html={description.length > 200 ? description.substring(0, 200) + '...' : description} />}
    <div class="mt-auto pt-4">
      <CustomButton
        variant="text"
        label={t("common.readMore")}
        url={slug}
        class="text-base-sm capitalize md:text-base"
      />
    </div>
  </div>
</div>
