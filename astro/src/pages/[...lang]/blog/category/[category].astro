---
import Base from "@/layouts/Base.astro";
import { getBlogs } from "@/lib/utils/strapiApi";
import BlogListPage from "@/components/BlogListPage.astro";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import CallToAction from "@/components/sections/CallToAction.astro";
import config from ".astro/config.generated.json" assert { type: "json" };

export const prerender = false;

export async function getStaticPaths() {
  // Fetch all blogs to extract categories
  const blogs = await getBlogs();
  const categoriesSet = new Set<string>();
  
  blogs.forEach(blog => {
    if (blog.categories) {
      blog.categories.split(',').forEach(cat => categoriesSet.add(cat.trim()));
    }
  });
  
  const categories = Array.from(categoriesSet).map(cat => ({
    name: cat,
    slug: cat.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')
  }));

  const paths = supportedLanguages.flatMap(lang => 
    categories.map(category => ({
      params: {
        category: category.slug,
        lang: lang.languageCode === 'en' ? undefined : lang.languageCode, // Assuming 'en' is default
      },
      props: { 
        categoryName: category.name,
        categorySlug: category.slug 
      },
    }))
  );

  return paths;
}

const { categoryName, categorySlug } = Astro.props;
---

<Base title={`${categoryName} - Insights & Updates`}>
  <PageHeader title={categoryName} subtitle={`Articles in ${categoryName} category`} />
  <BlogListPage filterContent={{ name: categoryName }} />
  <CallToAction />
</Base>
