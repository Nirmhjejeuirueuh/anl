---
import CallToAction from "@/components/sections/CallToAction.astro";
import Base from "@/layouts/Base.astro";
import { getBlogBySlug, STRAPI_URL } from "@/lib/utils/strapiApi";
import { markdownify } from "@/lib/utils/textConverter";
import { marked } from "marked";
import OptimizedImage from "@/layouts/components/utilities/OptimizedImage.astro";
import TableOfContents from "@/layouts/components/widgets/TableOfContents.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import dateFormat from "@/lib/utils/dateFormat";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { lang, slug } = Astro.params;

// Handle missing slug parameter
if (!slug) {
  console.log('No slug provided, redirecting to 404');
  return Astro.redirect('/404');
}

console.log('BLOG ROUTE: Route matched! Slug from URL:', slug);

// Fetch blog from Strapi by slug
let blog = null;
try {
  console.log('Fetching Strapi blog by slug:', slug);
  blog = await getBlogBySlug(slug);
  if (!blog) {
    console.log('Strapi blog not found for slug:', slug);
  }
} catch (error) {
  console.error('Error fetching Strapi blog:', error);
}

// Handle 404 if blog not found
if (!blog) {
  console.log('No blog found, redirecting to 404');
  return Astro.redirect('/404');
}

// Format publish date
const publishDate = blog.publishDate ? new Date(blog.publishDate) : new Date();

// Parse markdown content to HTML
const parsedContent = await marked.parse(blog.content || '');

// Format categories
const categories = blog.categories ? blog.categories.split(',').map(cat => cat.trim()) : [];

// Extract headings from markdown content for table of contents
function extractHeadings(content: string) {
  const headingRegex = /^(#{1,6})\s+(.+)$/gm;
  const headings = [];
  let match;

  while ((match = headingRegex.exec(content)) !== null) {
    const level = match[1].length;
    const text = match[2].trim();
    const slug = text.toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');

    headings.push({
      depth: level,
      slug,
      text
    });
  }

  return headings;
}

const headings = extractHeadings(blog.content || '');
const { tableOfContents } = config.settings.markup;
const tocEnabled = tableOfContents?.enable && headings?.length > 0;

console.log('ðŸš€ BLOG ROUTE: Extracted headings:', headings.length);
console.log('ðŸš€ BLOG ROUTE: TOC enabled:', tocEnabled);
console.log('ðŸš€ BLOG ROUTE: About to render blog:', blog.title);
console.log('ðŸš€ BLOG ROUTE: Raw content preview:', blog.content?.substring(0, 300));
console.log('ðŸš€ BLOG ROUTE: Raw content includes #:', blog.content?.includes('#'));
console.log('ðŸš€ BLOG ROUTE: Parsed content length:', parsedContent.length);
console.log('ðŸš€ BLOG ROUTE: Parsed content preview:', parsedContent.substring(0, 300));
---

<Base
  title={blog.title}
  description={blog.excerpt}
  image={blog.image ? `${STRAPI_URL}${blog.image.url}` : undefined}
>
  <section class="py-12">
    <div class="container">
      <div class="grid grid-cols-1 justify-items-center space-y-12">
        <!-- Blog Meta -->
        <div class="max-w-full space-y-8 text-center lg:max-w-3xl">
          <div>
            {categories && categories.length > 0 && (
              <ul class="mb-2 flex items-center justify-center gap-2">
                {categories.map((category: string) => (
                  <li class="inline-block text-sm font-medium tracking-wider">
                    <a href={`/${lang}/blog/category/${encodeURIComponent(category.toLowerCase().replace(/\s+/g, '-'))}`} class="hover:text-primary transition-colors">
                      {category}
                    </a>
                  </li>
                ))}
                <li>Â·</li>
                <li class="text-sm font-medium tracking-wider">
                  {dateFormat(publishDate)}
                </li>
              </ul>
            )}
            <h1 class="text-h3 md:text-h2">{blog.title}</h1>
            {blog.excerpt && <p class="text-muted">{blog.excerpt}</p>}
            {blog.author && (
              <div class="mt-4">
                <p class="text-sm text-muted">By {blog.author}</p>
              </div>
            )}
          </div>
        </div>

        <!-- Blog Image -->
        {blog.image && (
          <OptimizedImage
            src={`${STRAPI_URL}${blog.image.url}`}
            width={896}
            height={384}
            alt={blog.title}
            class="h-96 w-full object-cover lg:max-w-4xl"
          />
        )}

        <div class="w-full max-w-full space-y-8 lg:max-w-4xl">
          <!-- Table of Contents -->
          {tocEnabled && <TableOfContents toc={headings} marker={false} />}

          <!-- Main Content -->
          <div class="prose-styles content has-video-modal">
            <div set:html={parsedContent} />
          </div>
        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base></content>
<parameter name="filePath">b:\Projects\Work\Axcer\anl-revamp\astro\src\pages\blog\[...slug].astro