---
import Base from "@/layouts/Base.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import CareerSingle from "@/components/CareerSingle.astro";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import CallToAction from "@/components/sections/CallToAction.astro";
import config from ".astro/config.generated.json" assert { type: "json" };

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;
      const careerIndex = await getEntryCTM(
        "career",
        "-index",
        lang.languageCode,
      );

      let career = await getCollectionCTM("career", lang.languageCode);

      // If `draft` is true in `index.md`, exclude all pages for the collection in production
      if (careerIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      return career.map((entry) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          single:
            entry.data?.customSlug ||
            entry.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          career: entry,
          careerListPage: careerIndex,
        },
      }));
    }),
  );

  return paths.flat();
}

const { career, careerListPage } = Astro.props;
---

<Base {...career?.data}>
  <CareerSingle content={career} careerListPage={careerListPage} />
  <CallToAction />
</Base>
