---
import Base from "@/layouts/Base.astro";
import { getResourceLibraries } from "@/lib/utils/strapiApi";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import { generatePaths } from "@/lib/utils/i18nUtils.ts";
import { STRAPI_URL } from "@/lib/strapiApi";
import { markdownify } from "@/lib/utils/textConverter";

export function getStaticPaths() {
  return generatePaths();
}

export const prerender = false;

// Get slug from params
const { slug } = Astro.params;

// Fetch all resources and find the one with matching slug
const allResources = await getResourceLibraries();
const resource = allResources.find(r => r.slug === slug);

// If not found or not an article, redirect to 404
if (!resource || resource.resourceType !== 'article') {
  return Astro.redirect('/404');
}

// Mock page data
const indexData = {
  title: resource.title,
  subtitle: resource.category || '',
  metaDescription: resource.title,
  draft: false
};

// Helper function to extract YouTube video ID
function getYouTubeVideoId(url: string): string {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length == 11) ? match[2] : '';
}
---

<Base title={indexData.title} metaDescription={indexData.metaDescription} draft={indexData.draft}>
  <PageHeader {...indexData} />

  <!-- Article Content Section -->
  <section class="py-16 md:py-20 lg:py-24 bg-theme-light">
    <div class="container max-w-4xl">
      <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
        <!-- Article Image -->
        {(resource.image || resource.media || resource.resourceType === 'article') && resource.resourceType !== 'video' && (
          <div class="aspect-[16/9] overflow-hidden">
            <img
              src={
                resource.resourceType === 'article' ? '/images/articel.jpg' :
                resource.image ?
                  (resource.image.url.startsWith('http') ? resource.image.url : `${STRAPI_URL}${resource.image.url}`) :
                  (resource.media.url.startsWith('http') ? resource.media.url : `${STRAPI_URL}${resource.media.url}`)
              }
              alt={resource.title}
              class="w-full h-full object-cover"
            />
          </div>
        )}

        <!-- Article Header -->
        <div class="p-6 md:p-8 lg:p-12">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-4">
              <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${
                resource.resourceType === 'video' ? 'bg-red-100 text-red-800' :
                resource.resourceType === 'pdf' ? 'bg-blue-100 text-blue-800' :
                resource.resourceType === 'document' ? 'bg-green-100 text-green-800' :
                resource.resourceType === 'article' ? 'bg-purple-100 text-purple-800' :
                'bg-gray-100 text-gray-800'
              }`}>
                {resource.resourceType === 'video' && (
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                  </svg>
                )}
                {resource.resourceType === 'pdf' && (
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                  </svg>
                )}
                {resource.resourceType === 'document' && (
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/>
                  </svg>
                )}
                {resource.resourceType === 'article' && (
                  <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z" clip-rule="evenodd"/>
                  </svg>
                )}
                {resource.resourceType || 'other'}
              </span>
              {resource.featured && (
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                  Featured
                </span>
              )}
            </div>
            {resource.date && (
              <time class="text-sm text-gray-500" datetime={resource.date}>
                {new Date(resource.date).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </time>
            )}
          </div>

          <h1 class="text-3xl md:text-4xl lg:text-5xl text-primary mb-6 leading-tight">{resource.title}</h1>

          {resource.category && (
            <p class="text-lg text-gray-600 mb-8">Category: {resource.category}</p>
          )}

          <!-- Article Content -->
          {resource.article && (
            <div class="prose prose-lg max-w-none">
              {markdownify(resource.article)}
            </div>
          )}
        </div>
      </div>
    </div>
  </section>
</Base>