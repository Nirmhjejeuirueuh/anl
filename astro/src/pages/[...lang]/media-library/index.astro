---
import Base from "@/layouts/Base.astro";
import { generatePaths } from "@/lib/utils/i18nUtils.ts";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import ImageModal from "@/components/utilities/ImageModal.astro";
import { getMediaLibrary } from "@/lib/utils/strapiApi";
import { STRAPI_URL } from "@/lib/utils/strapiApi";
import { markdownify } from "@/lib/utils/textConverter";

export function getStaticPaths() {
  return generatePaths();
}

export const prerender = false;

// Fetch media library from Strapi
const mediaLibrary = await getMediaLibrary();

// Get current section from URL query parameter
const url = new URL(Astro.request.url);
const currentSection = url.searchParams.get('section') || (mediaLibrary?.sections?.[0]?.id?.toString() || '0');
---

<Base title={mediaLibrary?.title || "Media Library"} fitToScreen={false}>
  <PageHeader
    title={mediaLibrary?.title || "Media Library"}
    subtitle="Explore our collection of media resources"
  />

  {mediaLibrary?.sections && mediaLibrary.sections.length > 0 ? (
    <>
      <!-- Sections Ribbon -->
      <section class="py-6 bg-theme-light border-y border-gray-100">
        <div class="container">
          <div class={`flex items-center gap-4 overflow-x-auto pb-2 flex-nowrap ${mediaLibrary.sections.length <= 4 ? 'justify-center' : ''}`}>
            {mediaLibrary.sections.map((section, index: number) => {
              const isActive = currentSection === section.id?.toString();
              const sectionUrl = index === 0 ? '/media-library/' : `/media-library/?section=${section.id}`;
              return (
                <a
                  href={sectionUrl}
                  class={`inline-flex items-center px-4 py-2 font-medium rounded-full transition-colors whitespace-nowrap cursor-pointer ${
                    isActive
                      ? 'bg-primary text-white border border-primary shadow-md'
                      : 'bg-primary/5 hover:bg-primary/10 text-primary border border-primary/20 hover:border-primary/40'
                  }`}
                  data-aos="fade-up-sm"
                  data-aos-delay={index * 50}
                >
                  {section.title}
                  <svg class="ml-2 w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              );
            })}
          </div>
        </div>
      </section>

      <!-- Media Gallery -->
      <section class="py-6 bg-gray-50">
        <div class="container">
          {(() => {
            // Find current section or default to first
            const activeSection = mediaLibrary.sections.find(s => s.id?.toString() === currentSection) || mediaLibrary.sections[0];
            return (
              <>
                <div class="text-center mb-12">
                  <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">
                    {activeSection.title}
                  </h2>
                  {activeSection.description && (
                    <p class="text-lg text-gray-600 max-w-2xl mx-auto mb-4">{activeSection.description}</p>
                  )}
                  <p class="text-sm text-gray-500">
                    {activeSection.mediaItems.length} {activeSection.mediaItems.length === 1 ? 'image' : 'images'} loaded
                  </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-8xl mx-auto">
                  {activeSection.mediaItems.map((item) => (
                    <div class="group bg-white rounded-lg shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden cursor-pointer" onclick={`openImageModal('${item.image ? `${STRAPI_URL}${item.image.url}` : "/images/placeholder.jpg"}', '${item.caption}', '${item.altText || item.caption}', '${item.description || ''}')`}>
                      <div class="aspect-[16/9] overflow-hidden">
                        <img
                          src={item.image ? `${STRAPI_URL}${item.image.url}` : "/images/placeholder.jpg"}
                          alt={item.altText || item.caption}
                          loading="lazy"
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        />
                      </div>
                      <div class="p-4">
                        <h3 class="font-medium text-gray-900 text-center text-base">
                          {item.caption}
                        </h3>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            );
          })()}
        </div>
      </section>
    </>
  ) : (
    <section class="py-16 md:py-20 lg:py-24 bg-gray-50">
      <div class="container">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Media Library Coming Soon</h2>
          <p class="text-gray-600">We're working on organizing our media collection. Check back soon!</p>
        </div>
      </div>
    </section>
  )}

  <CallToAction/>

  <!-- Image Modal Component -->
  <ImageModal />
</Base>