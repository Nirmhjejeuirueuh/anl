---
import Base from "@/layouts/Base.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import { getTeamMemberBySlug, STRAPI_URL } from "@/lib/strapiApi";
import { markdownify } from "@/lib/utils/textConverter";
import OptimizedImage from "@/layouts/components/utilities/OptimizedImage.astro";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { lang, slug } = Astro.params;

// Handle missing slug parameter
if (!slug) {
  console.log('No slug provided, redirecting to 404');
  return Astro.redirect('/404');
}

console.log('TEAM MEMBER ROUTE: Route matched! Slug from URL:', slug);

// Fetch team member from Strapi by slug
let member = null;
try {
  console.log('Fetching Strapi team member by slug:', slug);
  member = await getTeamMemberBySlug(slug);
  if (!member) {
    console.log('Strapi team member not found for slug:', slug);
  }
} catch (error) {
  console.error('Error fetching Strapi team member:', error);
}

// Handle 404 if team member not found
if (!member) {
  console.log('No team member found, redirecting to 404');
  return Astro.redirect('/404');
}

// Page metadata
const pageData = {
  title: `${member.name} - Our Team`,
  description: `Learn more about ${member.name}, ${member.role} at AgilenLite.`,
  image: member.image || undefined,
};
---

<Base {...pageData}>
  <section class="py-12">
    <div class="container">
      <div class="mx-auto max-w-4xl">
        <div class="mb-8 text-center">
          {member.image && (
            <div class="mb-6 flex justify-center">
              <OptimizedImage
                src={member.image}
                alt={member.name}
                class="h-48 w-48 rounded-full object-cover"
                width={192}
                height={192}
              />
            </div>
          )}
          <h1 class="text-h2 mb-4" set:html={markdownify(member.name)} />
          <p class="text-xl text-primary font-medium mb-4" set:html={markdownify(member.role)} />
        </div>

        {member.description && (
          <div class="prose prose-lg mx-auto max-w-3xl">
            <div set:html={markdownify(member.description, true)} />
          </div>
        )}

        {member.social && member.social.enable && member.social.list && member.social.list.length > 0 && (
          <div class="mt-8 text-center">
            <h3 class="text-lg font-semibold mb-4">Connect with {member.name.split(' ')[0]}</h3>
            <div class="flex justify-center space-x-4">
              {member.social.list.map((social) => (
                <a
                  href={social.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-gray-600 hover:text-primary transition-colors"
                  title={social.label}
                >
                  <span class="sr-only">{social.label}</span>
                  <i class={`fab fa-${social.icon} text-2xl`}></i>
                </a>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </section>

  <CallToAction />
</Base>