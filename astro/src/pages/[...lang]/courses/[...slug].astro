---
import Base from "@/layouts/Base.astro";
import { getCourseBySlug, STRAPI_URL } from "@/lib/utils/strapiApi";
import CallToAction from "@/layouts/components/sections/CallToAction.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { markdownify, pluralize } from "@/lib/utils/textConverter";
import { marked } from "marked";
import OptimizedImage from "@/layouts/components/utilities/OptimizedImage.astro";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { lang, slug } = Astro.params;

// Handle missing slug parameter
if (!slug) {
  console.log('No slug provided, redirecting to 404');
  return Astro.redirect('/404');
}

// Check if slug is a page number (for pagination), let the page route handle it
if (/^\d+$/.test(slug)) {
  console.log('Numeric slug detected, letting page route handle it');
  // Don't redirect, let the request fall through to the page route
  return new Response(null, { status: 404 });
}

console.log('COURSE ROUTE: Route matched! Slug from URL:', slug);

// Fetch course from Strapi by slug
let strapiCourse = null;
try {
  console.log('Fetching Strapi course by slug:', slug);
  strapiCourse = await getCourseBySlug(slug);
  if (!strapiCourse) {
    console.log('Strapi course not found for slug:', slug);
  }
} catch (error) {
  console.error('Error fetching Strapi course:', error);
}

// Handle 404 if course not found
if (!strapiCourse) {
  console.log('No course found, redirecting to 404');
  return Astro.redirect('/404');
}

// Convert Strapi course to Astro format
import { convertStrapiCourseToAstro } from "@/lib/utils/strapiApi";
const course = convertStrapiCourseToAstro(strapiCourse);

// Parse markdown content to HTML
const parsedContent = await marked.parse(course.body || '');

// Format categories
const categories = course.data.courseFamily ? [course.data.courseFamily] : [];

// Additional course details
const tags = [];
const learningObjectives = course.data.learningObjectives ? course.data.learningObjectives.split('\n').filter(obj => obj.trim()) : [];
const prerequisites = [];

console.log('COURSE ROUTE: About to render course:', course.title);
---

<Base
  title={course.data.title}
  description={course.data.description}
  image={undefined}
>
  <section class="py-12">
    <div class="container">
      <div class="grid grid-cols-1 justify-items-center space-y-12">
        <!-- Course Meta -->
        <div class="max-w-full space-y-8 text-center lg:max-w-3xl">
          <div>
            <h1 class="text-h3 md:text-h2">{course.data.title}</h1>
            
            <!-- Course Info Row -->
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex flex-wrap justify-center items-center gap-4 text-sm text-muted">
                {course.data.moduleCode && <span>{course.data.moduleCode}</span>}
                {course.data.moduleCode && (course.data.courseFamily || course.data.trainingDays) && <span class="text-gray-400">|</span>}
                {course.data.courseFamily && <span>{course.data.courseFamily}</span>}
                {(course.data.moduleCode || course.data.courseFamily) && course.data.trainingDays && <span class="text-gray-400">|</span>}
                {course.data.trainingDays && <span>{course.data.trainingDays} {pluralize(course.data.trainingDays, 'day')}</span>}
              </div>
            </div>
          </div>
        </div>

        <!-- Course Details -->
        <div class="w-full max-w-full space-y-12 lg:max-w-4xl">
          <!-- Overview -->
          {course.data.description && (
            <div class="space-y-4">
              <h2 class="text-2xl font-bold">Overview</h2>
              <div class="prose prose-lg" set:html={markdownify(course.data.description)}></div>
            </div>
          )}

          <!-- Learning Objectives -->
          {course.data.learningObjectives && (
            <div class="space-y-4">
              <h2 class="text-2xl font-bold">Learning Objectives</h2>
              <div class="prose prose-lg" set:html={markdownify(course.data.learningObjectives)}></div>
            </div>
          )}

          <!-- Target Audience -->
          {course.data.targetAudience && (
            <div class="space-y-4">
              <h2 class="text-2xl font-bold">Target Audience</h2>
              <div class="prose prose-lg" set:html={markdownify(course.data.targetAudience)}></div>
            </div>
          )}

          <!-- Schedule -->
          {course.data.schedule && (
            <div class="space-y-4">
              <h2 class="text-2xl font-bold">Schedule</h2>
              <div class="flex items-center gap-3">
                <span class="text-text-default">{course.data.schedule}</span>
              </div>
            </div>
          )}

          <!-- Brochure -->
          {course.data.hyperlink && (
            <div class="space-y-4">
              <h2 class="text-2xl font-bold">Brochure</h2>
              <a
                href={course.data.hyperlink}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-8 py-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-lg font-medium"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                View Course Brochure
              </a>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base>
