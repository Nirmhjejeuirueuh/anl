---
import Base from "@/layouts/Base.astro";
import { getCourseBySlug } from "@/lib/utils/strapiApi";
import CallToAction from "@/layouts/components/sections/CallToAction.astro";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { markdownify } from "@/lib/utils/textConverter";
import { marked } from "marked";
import OptimizedImage from "@/layouts/components/utilities/OptimizedImage.astro";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { lang, slug } = Astro.params;

// Handle missing slug parameter
if (!slug) {
  console.log('No slug provided, redirecting to 404');
  return Astro.redirect('/404');
}

console.log('COURSE ROUTE: Route matched! Slug from URL:', slug);

// Fetch course from Strapi by slug
let course = null;
try {
  console.log('Fetching Strapi course by slug:', slug);
  course = await getCourseBySlug(slug);
  if (!course) {
    console.log('Strapi course not found for slug:', slug);
  }
} catch (error) {
  console.error('Error fetching Strapi course:', error);
}

// Handle 404 if course not found
if (!course) {
  console.log('No course found, redirecting to 404');
  return Astro.redirect('/404');
}

// Format publish date
const publishDate = course.publishDate ? new Date(course.publishDate) : new Date();

// Parse markdown content to HTML
const parsedContent = await marked.parse(course.content || '');

// Format categories
const categories = course.categories ? course.categories.split(',').map(cat => cat.trim()) : [];

console.log('COURSE ROUTE: About to render course:', course.title);
---

<Base
  title={course.title}
  description={course.excerpt}
  image={course.image ? `${'http://localhost:1337'}${course.image.url}` : undefined}
>
  <section class="py-12">
    <div class="container">
      <div class="grid grid-cols-1 justify-items-center space-y-12">
        <!-- Course Meta -->
        <div class="max-w-full space-y-8 text-center lg:max-w-3xl">
          <div>
            {categories && categories.length > 0 && (
              <ul class="mb-2 flex items-center justify-center gap-2">
                {categories.map((category: string) => (
                  <li class="inline-block text-sm font-medium tracking-wider">
                    <span class="bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium">
                      {category}
                    </span>
                  </li>
                ))}
              </ul>
            )}
            <h1 class="text-h3 md:text-h2">{course.title}</h1>
            {course.excerpt && <p class="text-muted">{course.excerpt}</p>}
            {course.instructor && (
              <div class="mt-4">
                <p class="text-sm text-muted">Instructor: {course.instructor}</p>
              </div>
            )}
            {(course.duration || course.level) && (
              <div class="mt-4 flex justify-center gap-4 text-sm text-muted">
                {course.duration && <span>Duration: {course.duration}</span>}
                {course.level && <span>Level: {course.level}</span>}
              </div>
            )}
          </div>
        </div>

        <!-- Course Image -->
        {course.image && (
          <OptimizedImage
            src={`${'http://localhost:1337'}${course.image.url}`}
            width={896}
            height={384}
            alt={course.title}
            class="h-96 w-full object-cover lg:max-w-4xl"
          />
        )}

        <div class="w-full max-w-full space-y-8 lg:max-w-4xl">
          <!-- Main Content -->
          <div class="prose-styles content">
            <div set:html={parsedContent} />
          </div>
        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base>
