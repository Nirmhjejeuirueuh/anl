---
import Base from "@/layouts/Base.astro";
import { getCourseBySlug, STRAPI_URL } from "@/lib/utils/strapiApi";
import CallToAction from "@/layouts/components/sections/CallToAction.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { markdownify } from "@/lib/utils/textConverter";
import { marked } from "marked";
import OptimizedImage from "@/layouts/components/utilities/OptimizedImage.astro";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { lang, slug } = Astro.params;

// Handle missing slug parameter
if (!slug) {
  console.log('No slug provided, redirecting to 404');
  return Astro.redirect('/404');
}

// Check if slug is a page number (for pagination), let the page route handle it
if (/^\d+$/.test(slug)) {
  console.log('Numeric slug detected, letting page route handle it');
  // Don't redirect, let the request fall through to the page route
  return new Response(null, { status: 404 });
}

console.log('COURSE ROUTE: Route matched! Slug from URL:', slug);

// Fetch course from Strapi by slug
let course = null;
try {
  console.log('Fetching Strapi course by slug:', slug);
  course = await getCourseBySlug(slug);
  if (!course) {
    console.log('Strapi course not found for slug:', slug);
  }
} catch (error) {
  console.error('Error fetching Strapi course:', error);
}

// Handle 404 if course not found
if (!course) {
  console.log('No course found, redirecting to 404');
  return Astro.redirect('/404');
}

// Parse markdown content to HTML
const parsedContent = await marked.parse(course.content || '');

// Format categories
const categories = course.categories ? course.categories.split(',').map(cat => cat.trim()) : [];

// Additional course details
const tags = course.tags ? course.tags.split(',').map(tag => tag.trim()) : [];
const learningObjectives = course.learningObjectives ? course.learningObjectives.split('\n').filter(obj => obj.trim()) : [];
const prerequisites = course.prerequisites ? course.prerequisites.split('\n').filter(pre => pre.trim()) : [];

console.log('COURSE ROUTE: About to render course:', course.title);
---

<Base
  title={course.title}
  description={course.excerpt}
  image={course.image ? (course.image.url.startsWith('http') ? course.image.url : `${STRAPI_URL}${course.image.url}`) : undefined}
>
  <section class="py-12">
    <div class="container">
      <div class="grid grid-cols-1 justify-items-center space-y-12">
        <!-- Course Meta -->
        <div class="max-w-full space-y-8 text-center lg:max-w-3xl">
          <div>
            <h1 class="text-h3 md:text-h2">{course.title}</h1>
            {course.excerpt && <p class="text-muted">{course.excerpt}</p>}
            {course.instructor && (
              <div class="mt-4">
                <p class="text-sm text-muted">By {course.instructor}</p>
              </div>
            )}
            
            <!-- Course Info Row -->
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
              <div class="flex flex-wrap justify-center items-center gap-4 text-sm text-muted">
                {course.moduleCode && <span>Course ID: {course.moduleCode}</span>}
                {course.moduleCode && (course.categories || course.duration) && <span class="text-gray-400">|</span>}
                {course.categories && <span>Category: {course.categories}</span>}
                {(course.moduleCode || course.categories) && course.duration && <span class="text-gray-400">|</span>}
                {course.duration && <span>Duration: {course.duration}</span>}
              </div>
            </div>
          </div>
        </div>

        <!-- Course Image -->
        {course.image && (
          <OptimizedImage
            src={course.image.url.startsWith('http') ? course.image.url : `${STRAPI_URL}${course.image.url}`}
            width={896}
            height={384}
            alt={course.title}
            class="h-96 w-full object-cover lg:max-w-4xl"
          />
        )}

        <div class="w-full max-w-full space-y-8 lg:max-w-4xl">
          <!-- Main Content -->
          <div class="prose-styles content">
            <div set:html={parsedContent} />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Target Audience & Schedule -->
  {(course.targetAudience || course.trainingTime || course.trainingDate) && (
    <section class="py-16 bg-gray-50">
      <div class="container">
        <div class="max-w-4xl mx-auto">
          <div class="grid md:grid-cols-2 gap-12">
            <!-- Target Audience -->
            {course.targetAudience && (
              <div>
                <h2 class="text-3xl font-bold mb-8">Target Audience</h2>
                <div class="prose prose-lg" set:html={markdownify(course.targetAudience)}></div>
              </div>
            )}

            <!-- Schedule -->
            {(course.trainingTime || course.trainingDate) && (
              <div>
                <h2 class="text-3xl font-bold mb-8">Schedule</h2>
                <div class="space-y-4">
                  {course.trainingTime && (
                    <div class="flex items-center gap-3">
                      <span class="font-semibold">Time:</span>
                      <span class="text-text-default">{course.trainingTime}</span>
                    </div>
                  )}
                  {course.trainingDate && (
                    <div class="flex items-center gap-3">
                      <span class="font-semibold">Training Date:</span>
                      <span class="text-text-default">{course.trainingDate}</span>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Brochure -->
  {course.hyperlink && (
    <section class="py-6 pb-30 bg-gray-50">
      <div class="container">
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl font-bold mb-8">Brochure</h2>
          <a
            href={course.hyperlink}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-8 py-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-lg font-medium"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            View Course Brochure
          </a>
        </div>
      </div>
    </section>
  )}

  <CallToAction />
</Base>
