---
import Base from "@/layouts/Base.astro";
import { getEntryCTM, getCollectionCTM } from "@/lib/contentParser.astro";
import handleDraftPage from "@/lib/utils/handleDraftPage";
import CallToAction from "@/layouts/components/sections/CallToAction.astro";
import CoursesSection from "@/layouts/components/sections/CoursesSection.astro";
import FaqSection from "@/layouts/components/sections/FaqSection.astro";
import PageHeader from "@/components/widgets/PageHeader.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { getSupportedLanguages } from "@/lib/utils/i18nUtils.ts";
import { markdownify } from "@/lib/utils/textConverter";

export async function getStaticPaths() {
  const supportedLanguages = getSupportedLanguages();
  const { defaultLanguage, showDefaultLangInUrl } = config.settings.multilingual;

  const allPaths = [];

  for (const lang of supportedLanguages) {
    const courses = await getCollectionCTM(
      config.settings.coursesFolder as "courses",
      lang.languageCode
    );

    const paths = courses.map((course) => ({
      params: {
        lang:
          lang.languageCode === defaultLanguage && !showDefaultLangInUrl
            ? undefined
            : lang.languageCode,
        slug: course.id
          .replace(/\.mdx?|\.md/g, "")
          .split("/")
          .pop(),
      },
      props: { course },
    }));

    allPaths.push(...paths);
  }

  return allPaths;
}

const { course } = Astro.props;
const { data, id } = course;

// Remove drafts pages in production
const response = handleDraftPage(data);
if (response) return response;

const entry = await getEntryCTM("courses", "-index", Astro.currentLocale);
const coursesSection = entry?.data?.coursesSection;

// Render the course content
const { Content } = await course.render();

const {
  title,
  metaDescription,
  draft,
  hasCustomLineAnimationBg,
  description,
  category,
  trainingDays,
  targetAudience,
  moduleCode,
  trainingTime,
  trainingDate,
  hyperlink,
  ...rest
} = data;
---

<Base
  title={title}
  metaDescription={metaDescription}
  draft={draft}
  sectionSpacing="lg"
  className={hasCustomLineAnimationBg ? "has-custom-line-animation-bg" : ""}
>
  <PageHeader title={title} />

  <!-- Course Content -->
  <section class="py-16">
    <div class="container">
      <div class="max-w-4xl mx-auto prose prose-lg">
        <Content />
      </div>
    </div>
  </section>

  <!-- Target Audience & Schedule -->
  {(targetAudience || trainingTime || trainingDate) && (
    <section class="py-16 bg-gray-50">
      <div class="container">
        <div class="max-w-4xl mx-auto">
          <div class="grid md:grid-cols-2 gap-12">
            <!-- Target Audience -->
            {targetAudience && (
              <div>
                <h2 class="text-3xl font-bold mb-8">Target Audience</h2>
                <div class="prose prose-lg" set:html={markdownify(targetAudience)}></div>
              </div>
            )}

            <!-- Schedule -->
            {(trainingTime || trainingDate) && (
              <div>
                <h2 class="text-3xl font-bold mb-8">Schedule</h2>
                <div class="space-y-4">
                  {trainingTime && (
                    <div class="flex items-center gap-3">
                      <span class="font-semibold">Time:</span>
                      <span class="text-text-default">{trainingTime}</span>
                    </div>
                  )}
                  {trainingDate && (
                    <div class="flex items-center gap-3">
                      <span class="font-semibold">Training Date:</span>
                      <span class="text-text-default">{trainingDate}</span>
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Brochure -->
  {hyperlink && (
    <section class="py-6 pb-30 bg-gray-50">
      <div class="container">
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-3xl font-bold mb-8">Brochure</h2>
          <a 
            href={hyperlink}
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 px-8 py-4 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors text-lg font-medium"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            View Course Brochure
          </a>
        </div>
      </div>
    </section>
  )}

  <div class="">
    <CoursesSection content={coursesSection} />
  </div>
  <div class="">


  <CallToAction />
</div>
</Base>
