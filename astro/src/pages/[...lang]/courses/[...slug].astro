---
import Base from "@/layouts/Base.astro";
import { getEntryCTM, getCollectionCTM } from "@/lib/contentParser.astro";
import handleDraftPage from "@/lib/utils/handleDraftPage";
import CallToAction from "@/layouts/components/sections/CallToAction.astro";
import CoursesSection from "@/layouts/components/sections/CoursesSection.astro";
import FaqSection from "@/layouts/components/sections/FaqSection.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { getSupportedLanguages } from "@/lib/utils/i18nUtils.ts";
import { markdownify } from "@/lib/utils/textConverter";

export async function getStaticPaths() {
  const supportedLanguages = getSupportedLanguages();
  const { defaultLanguage, showDefaultLangInUrl } = config.settings.multilingual;

  const allPaths = [];

  for (const lang of supportedLanguages) {
    const courses = await getCollectionCTM(
      config.settings.coursesFolder as "courses",
      lang.languageCode
    );

    const paths = courses.map((course) => ({
      params: {
        lang:
          lang.languageCode === defaultLanguage && !showDefaultLangInUrl
            ? undefined
            : lang.languageCode,
        slug: course.id
          .replace(/\.mdx?|\.md/g, "")
          .split("/")
          .pop(),
      },
      props: { course },
    }));

    allPaths.push(...paths);
  }

  return allPaths;
}

const { course } = Astro.props;
const { data, id } = course;

// Remove drafts pages in production
const response = handleDraftPage(data);
if (response) return response;

const entry = await getEntryCTM("courses", "-index", Astro.currentLocale);
const coursesSection = entry?.data?.coursesSection;

const {
  title,
  metaDescription,
  draft,
  hasCustomLineAnimationBg,
  description,
  category,
  trainingDays,
  targetAudience,
  moduleCode,
  ...rest
} = data;
---

<Base
  title={title}
  metaDescription={metaDescription}
  draft={draft}
  sectionSpacing="lg"
  className={hasCustomLineAnimationBg ? "has-custom-line-animation-bg" : ""}
>
  <!-- Course Header -->
  <section class="pt-32 pb-16 bg-theme-light">
    <div class="container">
      <div class="max-w-4xl mx-auto text-center">
        {category && (
          <span class="inline-block px-4 py-2 mb-4 text-sm font-medium text-primary bg-primary/10 rounded-full">
            {category}
          </span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-dark mb-6">
          {title}
        </h1>
        {description && (
          <div class="text-lg text-text-default opacity-80 mb-8" set:html={markdownify(description)}></div>
        )}
        <div class="flex flex-wrap justify-center gap-6 text-sm text-text-default">
          {trainingDays && (
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>{trainingDays} day{trainingDays > 1 ? 's' : ''}</span>
            </div>
          )}
          {moduleCode && (
            <div class="flex items-center gap-2">
              <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              <span>{moduleCode}</span>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Course Content -->
  {data.body && (
    <section class="py-16">
      <div class="container">
        <div class="max-w-4xl mx-auto prose prose-lg" set:html={data.body}></div>
      </div>
    </section>
  )}

  <!-- Target Audience -->
  {targetAudience && (
    <section class="py-16 bg-gray-50">
      <div class="container">
        <div class="max-w-4xl mx-auto">
          <h2 class="text-3xl font-bold text-center mb-8">Who Should Attend</h2>
          <div class="prose prose-lg mx-auto" set:html={markdownify(targetAudience)}></div>
        </div>
      </div>
    </section>
  )}

  <CoursesSection content={coursesSection} />
  <FaqSection content={data.faqSection} />
  <CallToAction />
</Base>
