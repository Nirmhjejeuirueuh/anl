---
import Base from "@/layouts/Base.astro";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import PageHeader from "@/components/widgets/PageHeader.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";
import CoursesSection from "@/layouts/components/sections/CoursesSection.astro";

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { coursesFolder } = config.settings;
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      const courseIndex = await getEntryCTM(
        coursesFolder as "courses",
        "-index",
        lang.languageCode,
      );

      const courses = await getCollectionCTM(
        coursesFolder as "courses",
        lang.languageCode,
      );
      const totalPages = Math.ceil(courses.length / config.settings.pagination);
      const paths = [];

      // If draft true in index.md file frontmatter don't include any page related to this page collection in production
      if (courseIndex?.data.draft && import.meta.env.PROD) {
        return [];
      }

      // Disable page generation if config.settings.pagination is 0 or false
      if (config.settings.pagination === 0 || !config.settings.pagination) {
        return [];
      }

      for (let i = 1; i < totalPages; i++) {
        paths.push({
          params: {
            slug: (i + 1).toString(),
          },
        });
      }

      return paths.map((path) => ({
        params: {
          slug: path.params.slug,
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
        },
        props: {
          courseIndex,
          pagination: config.settings.pagination,
          courseCollection: courses,
        },
      }));
    }),
  );

  return paths.flat();
}

const { slug } = Astro.params;
const currentPage = slug && !isNaN(Number(slug)) ? Number(slug) : 1;
let { courseIndex, courseCollection } = Astro.props;

// Extract only the props needed for Base component
const {
  title,
  metaDescription,
  draft,
  metaTitle,
  robots,
  hasCustomLineAnimationBg,
} = courseIndex?.data || {};
---

<Base
  title={title}
  metaDescription={metaDescription}
  draft={draft}
  metaTitle={metaTitle}
  robots={robots}
  className={hasCustomLineAnimationBg ? "has-custom-line-animation-bg" : ""}
>
  <PageHeader 
    title={courseIndex?.data?.title}
  />

  <CoursesSection
    content={{
      ...courseIndex?.data.indexCoursesSection,
      pagination: { enable: true, currentPage }
    }}
    courses={courseCollection}
  />

  <CallToAction />
</Base>