---
import Base from "@/layouts/Base.astro";
import { getCourses, convertStrapiCourseToAstro } from "@/lib/utils/strapiApi";
import CallToAction from "@/components/sections/CallToAction.astro";
import CoursesSection from "@/layouts/components/sections/CoursesSection.astro";
import CourseFilters from "@/layouts/components/widgets/CourseFilters.astro";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import config from ".astro/config.generated.json" assert { type: "json" };
import { supportedLanguages } from "@/lib/utils/i18nUtils.ts";

export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } = config.settings.multilingual;
      
      // Fetch total courses to calculate pages
      const courses = await getCourses();
      const COURSES_PER_PAGE = 9;
      const totalPages = Math.ceil(courses.length / COURSES_PER_PAGE);
      
      const pagePaths = [];
      // Start from page 2 since page 1 is the index
      for (let i = 2; i <= totalPages; i++) {
        pagePaths.push({
          params: {
            lang: lang.languageCode === defaultLanguage && !showDefaultLangInUrl ? undefined : lang.languageCode,
            page: i.toString(),
          },
        });
      }
      
      return pagePaths;
    })
  );

  return paths.flat();
}

// Fetch courses from Strapi and convert to Astro format
const strapiCourses = await getCourses();
const courses = strapiCourses.map(convertStrapiCourseToAstro);

// Get current page from URL parameter
const page = (Astro.params as any).page;
const currentPage = parseInt(page || '1');

// Mock index page data (since we don't have MDX index file)
const indexData = {
  title: "Professional Training Courses",
  subtitle: "Enhance your skills with our expert-led training programs",
  metaDescription: "AgileN Lite offers comprehensive training courses in Agile Methodologies, Cybersecurity, Risk Management, Governance, and Financial Services Technology. Upskill your team with industry-leading professional development programs.",
  draft: false,
  hasCustomLineAnimationBg: false,
  indexCoursesSection: {
    enable: true,
    title: "",
    subtitle: "",
    creativeShape: {
      enable: true,
      position: "top" as const
    },
    cta: "link" as const,
    colorScheme: "light" as const,
    showCoursesAs: "static" as const,
    limit: false as const,
    enableFilters: true,
    pagination: {
      enable: true,
      currentPage: currentPage
    }
  }
};
---

<Base
  title={`${indexData.title} - Page ${currentPage}`}
  metaDescription={indexData.metaDescription}
  draft={indexData.draft}
  className={indexData.hasCustomLineAnimationBg ? "has-custom-line-animation-bg" : ""}
>
  <PageHeader {...indexData} />

  <!-- Course Filters Section -->
  <section class="pt-4 pb-8 bg-theme-light">
    <div class="container">
      <CourseFilters courses={courses} />
    </div>
  </section>

  <CoursesSection content={indexData.indexCoursesSection} courses={courses} />
</Base>