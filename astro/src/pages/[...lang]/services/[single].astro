---
import Base from "@/layouts/Base.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import { STRAPI_URL } from "@/lib/strapiApi";
import { generatePaths } from "@/lib/utils/i18nUtils.ts";
import { markdownify } from "@/lib/utils/textConverter";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { single: endpoint } = Astro.params as any;

// Fetch services page to get the service data
const response = await fetch(`${STRAPI_URL}/api/services-page?populate[services][populate]=image`);
if (!response.ok) {
  throw new Error(`Failed to fetch services page: ${response.status}`);
}
const strapiData = await response.json();

// Find the service that matches the endpoint
const service = strapiData.data?.services?.find((s: any) => 
  s.endpoint === endpoint || s.endpoint === `/${endpoint}`
);

if (!service) {
  throw new Error(`Service with endpoint "${endpoint}" not found`);
}
---

<Base title={service.title} fitToScreen={false}>
  <PageHeader title={service.title} />

  <!-- Service Hero Section -->
  <section class="relative py-16 md:py-20 lg:py-24 -mt-16">
    <div class="container">
      <div class="mx-auto max-w-4xl">
        <div class="grid gap-12 lg:grid-cols-2 lg:gap-16 items-center">
          <!-- Content -->
          <div data-aos="fade-up-sm">
            <h1 class="text-h2 md:text-h1 text-primary mb-6">{service.title}</h1>
            <div class="prose prose-lg prose-gray max-w-none text-justify">
              <div set:html={markdownify(service.description, true)}></div>
            </div>
          </div>

          <!-- Image -->
          {service.image && (
            <div data-aos="fade-up-sm" data-aos-delay="200" class="relative">
              <div class="aspect-[4/3] overflow-hidden rounded-2xl shadow-xl">
                <img
                  src={`${STRAPI_URL}${service.image.url}`}
                  alt={service.title}
                  class="w-full h-full object-cover"
                />
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base>
