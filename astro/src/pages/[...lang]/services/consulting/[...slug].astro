---
import ProgramPageTemplate from "@/components/ProgramPageTemplate.astro";
import { getConsultantBySlug, getConsultants } from "@/lib/utils/strapiApi";
import { generatePaths } from "@/lib/utils/i18nUtils.ts";
import { markdownify } from "@/lib/utils/textConverter";

export function getStaticPaths() {
  return generatePaths();
}

export const prerender = false;

const { slug } = Astro.params as any;

// Fetch consultant by slug
// Pass Astro.request to enable hard refresh detection
const consultant = await getConsultantBySlug(slug, Astro.request);

// If consultant has a URL field, redirect to it
if (consultant?.URL) {
  return Astro.redirect(consultant.URL);
}

// Fetch all consultants for the ribbon
const allConsultants = await getConsultants(Astro.request);

if (!consultant) {
  throw new Error(`Consultant with slug "${slug}" not found`);
}

// Parse markdown content to HTML using markdownify
const parsedContent = markdownify(consultant.content || '', true);

const pageData = {
  title: consultant.title,
  subtitle: "Professional Consulting Service",
  metaDescription: consultant.description || consultant.title,
  description: parsedContent
};
---

<ProgramPageTemplate
  title={pageData.title}
  subtitle={pageData.subtitle}
  metaDescription={pageData.metaDescription}
  description={pageData.description}
  programs={allConsultants}
  currentSlug={slug}
  basePath="/services/consulting"
  label="Consulting Services"
  lang={Astro.params.lang}
/>