---
import ProgramPageTemplate from "@/components/ProgramPageTemplate.astro";
import { getTrainingBySlug, getTrainings } from "@/lib/utils/strapiApi";
import { generatePaths } from "@/lib/utils/i18nUtils.ts";
import { markdownify } from "@/lib/utils/textConverter";

export function getStaticPaths() {
  return generatePaths();
}

export const prerender = false;

const { slug } = Astro.params as any;

// Fetch training by slug
// Pass Astro.request to enable hard refresh detection
const training = await getTrainingBySlug(slug, Astro.request);

// If training has a URL field, redirect to it
if (training?.URL) {
  return Astro.redirect(training.URL);
}

// Fetch all trainings for the ribbon
const allTrainings = await getTrainings(Astro.request);

if (!training) {
  throw new Error(`Training with slug "${slug}" not found`);
}

// Parse markdown content to HTML using markdownify
const parsedContent = markdownify(training.content || '', true);

const pageData = {
  title: training.title,
  subtitle: "Professional Training Program",
  metaDescription: training.description || training.title,
  description: parsedContent
};
---

<ProgramPageTemplate
  title={pageData.title}
  subtitle={pageData.subtitle}
  metaDescription={pageData.metaDescription}
  description={pageData.description}
  programs={allTrainings}
  currentSlug={slug}
  basePath="/services/training"
  label="Training Programs"
  lang={Astro.params.lang}
/>