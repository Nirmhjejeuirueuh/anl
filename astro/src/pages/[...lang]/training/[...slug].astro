---
import Base from "@/layouts/Base.astro";
import CallToAction from "@/components/sections/CallToAction.astro";
import PageHeader from "@/layouts/components/widgets/PageHeader.astro";
import HtmlContentContainer from "@/components/HtmlContentContainer.astro";
import { getTrainingBySlug } from "@/lib/utils/strapiApi";
import { generatePaths } from "@/lib/utils/i18nUtils.ts";
import { Marked } from "marked";

// Enable SSR for dynamic Strapi content
export const prerender = false;

const { slug } = Astro.params as any;

// Fetch training by slug
const training = await getTrainingBySlug(slug);

if (!training) {
  throw new Error(`Training with slug "${slug}" not found`);
}

// Create a new marked instance with custom renderer for marked v16+
const marked = new Marked({
  gfm: true,
  breaks: true,
});

// Override the renderer methods using the new API
marked.use({
  renderer: {
    // Handle images with proper img tags
    image(token: any) {
      const titleAttr = token.title ? ` title="${token.title}"` : '';
      return `<img src="${token.href}" alt="${token.text}"${titleAttr} class="markdown-image" />`;
    },
    // Handle links with target="_blank"
    link(token: any) {
      const titleAttr = token.title ? ` title="${token.title}"` : '';
      return `<a href="${token.href}"${titleAttr} target="_blank" rel="noopener noreferrer">${token.text}</a>`;
    }
  }
});

// Debug: Log content before and after parsing
console.log('=== Training Content Debug ===');
console.log('Raw markdown (first 500 chars):', training.content?.substring(0, 500));

// Parse markdown content to HTML
const parsedContent = await marked.parse(training.content || '');

console.log('Parsed HTML (first 500 chars):', parsedContent.substring(0, 500));
console.log('==============================');
---

<Base title={training.title} metaDescription={training.description}>

  <!-- Hero Section -->
  <section class="py-12">
    <div class="container">
      <div class="grid grid-cols-1 justify-items-center space-y-12">
        <!-- Training Meta -->
        <div class="max-w-full space-y-8 text-center lg:max-w-3xl">
          <div>
            <h1 class="text-h3 md:text-h2">{training.title}</h1>
            <div class="page-header">
              <hr class="hr-ornate">
            </div>
            {training.description && (
              <p class="text-muted mt-6">{training.description}</p>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Training Content Section -->
  <section class="relative py-16 md:py-20 lg:py-24 -mt-16">
    <div class="container">
      <div class="mx-auto max-w-4xl">
        <div class="space-y-8 md:space-y-12">
          <!-- Training Content -->
          <div
            data-aos="fade-up-sm"
            class="prose-styles content">
            {training.content && (
              <HtmlContentContainer set:html={parsedContent} />
            )}
          </div>

        </div>
      </div>
    </div>
  </section>

  <CallToAction />
</Base>